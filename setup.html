<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>On-the-Go AppSuite - Setup Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    .step { display: none; }
    .step.active { display: block; }
    .step-nav button { @apply transition-all duration-200 px-4 py-2 text-sm font-medium rounded-md; }
    .step-nav button.current { @apply bg-blue-600 text-white font-semibold; }
    .copy-btn { @apply absolute top-3 right-3 bg-gray-600 text-white text-xs px-2 py-1 rounded hover:bg-gray-500 transition; }
    .copy-btn.copied { @apply bg-green-600; }
    .hidden-field { transition: all 0.4s ease; overflow: hidden; }
    .hidden-field.closed { opacity: 0; height: 0; margin: 0; padding: 0; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-blue-400 mb-2">On-the-Go AppSuite</h1>
      <p class="text-xl text-gray-400">Full Production Setup Wizard • November 2025</p>
    </div>

    <!-- Updated Step Navigation -->
    <div class="step-nav flex flex-wrap justify-center gap-3 mb-10 bg-gray-800 p-4 rounded-xl shadow-lg">
      <button type="button" class="current" onclick="showStep(1)">1. Welcome</button>
      <button type="button" onclick="showStep(2)">2. Sheet Setup</button>
      <button type="button" onclick="showStep(3)">3. Configuration</button>
      <button type="button" onclick="showStep(4)">4. Deploy Script</button>
      <button type="button" onclick="showStep(5)">5. Paste URL</button>
      <button type="button" onclick="showStep(6)">6. Done!</button>
    </div>

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12">

      <!-- Step 1: Welcome (unchanged) -->
      <div id="step1" class="step active space-y-10">
        <h2 class="text-3xl font-bold text-center text-blue-300">Welcome! Choose Your App Type</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <label class="block cursor-pointer">
            <input type="radio" name="appMode" value="simple" checked onchange="toggleAdvanced()" class="hidden peer">
            <div class="bg-gray-900 border-2 border-gray-700 rounded-xl p-8 text-center hover:border-blue-500 transition peer-checked:border-blue-500 peer-checked:bg-blue-900/20">
              <div class="text-6xl mb-4">Shield</div>
              <h3 class="text-2xl font-bold">Simple App</h3>
              <p class="text-gray-400 mt-3">Safety-only • Timer • SOS • Duress PIN</p>
              <p class="text-green-400 font-bold mt-4">Most Popular</p>
            </div>
          </label>
          <label class="block cursor-pointer">
            <input type="radio" name="appMode" value="advanced" onchange="toggleAdvanced()" class="hidden peer">
            <div class="bg-gray-900 border-2 border-gray-700 rounded-xl p-8 text-center hover:border-blue-500 transition peer-checked:border-blue-500 peer-checked:bg-blue-900/20">
              <div class="text-6xl mb-4">Tools</div>
              <h3 class="text-2xl font-bold">Advanced App</h3>
              <p class="text-gray-400 mt-3">Full reporting • Photos • Gemini AI • Distance tracking</p>
              <p class="text-yellow-400 font-bold mt-4">Reporting Features</p>
            </div>
          </label>
        </div>
        <div class="text-center space-y-6">
          <a href="Templates/OTG_AppSuite_Documentation.pdf" target="_blank" class="inline-block bg-indigo-600 hover:bg-indigo-700 px-10 py-4 rounded-xl font-bold text-xl">
            Download Full Documentation (PDF)
          </a>
          <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 px-12 py-5 rounded-xl font-bold text-2xl ml-6">
            Start Setup
          </button>
        </div>
      </div>

      <!-- Step 2: Sheet Setup (unchanged) -->
      <div id="step2" class="step space-y-8">
        <h2 class="text-3xl font-bold text-center text-blue-300">Step 2: Google Sheet Headers</h2>
        <ol class="list-decimal list-inside text-xl text-gray-300 space-y-4 max-w-4xl mx-auto">
          <li>Create sheet at <a href="https://sheets.new" target="_blank" class="text-blue-400 underline">sheets.new</a></li>
          <li>Rename first tab → <strong>Visits</strong></li>
          <li id="checklistsNote" class="text-yellow-300 font-bold hidden">Also create second tab → <strong>Checklists</strong></li>
        </ol>
        <div class="relative bg-gray-900 p-8 rounded-xl border border-gray-700 max-w-5xl mx-auto font-mono text-sm">
          <button type="button" onclick="copyHeaders()" class="copy-btn">Copy</button>
          <pre id="headers" class="text-gray-400 overflow-x-auto">Date,Worker Name,Worker Phone Number,Emergency Contact Name,Emergency Contact Number,Emergency Contact Email,Escalation Contact Name,Escalation Contact Number,Escalation Contact Email,Location Name,Location Address,Arrival Time,Anticipated Departure Time,Actual Departure Time,Alarm Status,Notes,Last Known GPS,GPS Timestamp,Battery Level</pre>
        </div>
        <div class="text-center">
          <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 px-12 py-5 rounded-xl font-bold text-xl">
            Done → Next
          </button>
        </div>
      </div>

      <!-- Step 3: Configuration (unchanged) -->
      <div id="step3" class="step space-y-10">
        <h2 class="text-3xl font-bold text-center text-blue-300">Step 3: Your Settings</h2>
        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          <div><label class="block text-lg font-medium mb-2">Organisation Name</label><input type="text" id="orgName" value="My Company" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">Secret Key (Monitor Dashboard)</label><input type="password" id="secretKey" placeholder="Strong password" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">First Alert After (minutes)</label><input type="number" id="firstAlert" value="15" min="1" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">Escalation After (minutes)</label><input type="number" id="escalation" value="5" min="1" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div id="orsField" class="hidden-field closed"><label class="block text-lg font-medium mb-2 text-yellow-300">OpenRouteService API Key (Distance)</label><input type="text" id="orsKey" placeholder="Optional • openrouteservice.org" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div id="geminiField" class="hidden-field closed"><label class="block text-lg font-medium mb-2 text-yellow-300">Gemini API Key (AI Spellcheck)</label><input type="text" id="geminiKey" placeholder="Optional • aistudio.google.com" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div class="md:col-span-2">
            <label class="flex items-center space-x-4 text-lg">
              <input type="checkbox" id="checkinEnabled" class="h-6 w-6 text-blue-600">
              <span>Enable check-ins every</span>
              <input type="number" id="checkinInterval" value="30" min="5" class="w-24 px-4 py-3 bg-gray-700 rounded-lg mx-2">
              <span>minutes</span>
            </label>
          </div>
        </div>
        <div class="text-center">
          <button onclick="generateScriptAndProceed()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-16 py-6 rounded-xl font-bold text-2xl shadow-2xl transform hover:scale-105 transition">
            Generate Apps Script Code →
          </button>
        </div>
      </div>

      <!-- Step 4: Deploy Apps Script -->
      <div id="step4" class="step space-y-8 text-center">
        <h2 class="text-3xl font-bold text-blue-300">Step 4: Deploy Your Google Apps Script</h2>
        <p class="text-xl text-gray-300 max-w-4xl mx-auto">Click below → paste the code → Deploy as Web App → Copy the /exec URL</p>
        <div class="relative bg-gray-900 p-8 rounded-xl border border-gray-700 max-w-5xl mx-auto font-mono text-sm">
          <button type="button" onclick="copyScript()" class="copy-btn">Copy All</button>
          <pre id="scriptDisplay" class="text-left text-gray-400 overflow-x-auto h-96"></pre>
        </div>
        <div class="flex justify-center gap-6 mt-8">
          <a href="https://script.new" target="_blank" class="bg-blue-600 hover:bg-blue-700 px-10 py-5 rounded-xl font-bold text-xl">Open script.new</a>
          <button onclick="nextStep()" class="bg-green-600 hover:bg-green-700 px-12 py-5 rounded-xl font-bold text-xl">I’ve Deployed It →</button>
        </div>
      </div>

      <!-- Step 5: Paste Web App URL -->
      <div id="step5" class="step space-y-8 text-center">
        <h2 class="text-3xl font-bold text-blue-300">Step 5: Paste Your Web App URL</h2>
        <p class="text-xl text-gray-300">Copy the URL that ends in <code class="bg-gray-700 px-3 py-1 rounded">/exec</code></p>
        <input type="url" id="webAppUrl" placeholder="https://script.google.com/macros/s/AKfyc.../exec" class="w-full max-w-3xl mx-auto px-6 py-5 bg-gray-700 rounded-xl text-lg text-center">
        <button onclick="finalizeWithWebAppUrl()" class="mt-8 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-20 py-8 rounded-xl font-bold text-3xl shadow-2xl transform hover:scale-105 transition">
          Generate Final Apps →
        </button>
      </div>

      <!-- Step 6: Success -->
      <div id="step6" class="step text-center py-20 space-y-12">
        <div class="text-9xl">Success</div>
        <h2 class="text-5xl font-bold text-green-400">Your Complete App Package Is Ready!</h2>
        <p class="text-2xl text-gray-300 max-w-3xl mx-auto">Fully configured and linked to your Google Sheet</p>
        <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 px-20 py-10 rounded-3xl font-bold text-4xl shadow-2xl transform hover:scale-110 transition">
          Download OTG_AppSuite.zip
        </button>
      </div>

    </div>
  </div>

  <script>
    const REPO_RAW = "https://raw.githubusercontent.com/loneworkernelson-web/LoneWorkerFullOTGPackage/main/Templates";
    let config = {}, gasCode = "", finalZip;

    function toggleAdvanced() {
      const adv = document.querySelector('input[value="advanced"]').checked;
      document.getElementById('checklistsNote').classList.toggle('hidden', !adv);
      document.querySelectorAll('.hidden-field').forEach(el => el.classList.toggle('closed', !adv));
    }

    function showStep(n) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + n).classList.add('active');
      document.querySelectorAll('.step-nav button').forEach((b, i) => b.classList.toggle('current', i + 1 === n));
    }

    function nextStep() {
      const current = +document.querySelector('.step.active').id.replace('step', '');
      showStep(current + 1);
    }

    function copyHeaders() {
      navigator.clipboard.writeText(document.getElementById('headers').textContent);
      const btn = document.querySelector('#step2 .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
    }

    function copyScript() {
      navigator.clipboard.writeText(gasCode);
      const btn = document.querySelector('#step4 .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
    }

    async function generateScriptAndProceed() {
      config = {
        orgName: document.getElementById('orgName').value || "My Company",
        secretKey: document.getElementById('secretKey').value || "changeme123",
        firstAlert: document.getElementById('firstAlert').value,
        escalation: document.getElementById('escalation').value,
        orsKey: document.getElementById('orsKey').value,
        geminiKey: document.getElementById('geminiKey').value,
        checkinEnabled: document.getElementById('checkinEnabled').checked,
        checkinInterval: document.getElementById('checkinInterval').value,
        advanced: document.querySelector('input[value="advanced"]').checked
      };

      const template = await fetch(`${REPO_RAW}/apps_script_advanced.txt?t=${Date.now()}`).then(r => r.text());
      gasCode = template.replace(/%%SECRET_KEY%%/g, config.secretKey);
      document.getElementById('scriptDisplay').textContent = gasCode;
      showStep(4);
    }

    async function finalizeWithWebAppUrl() {
      const webAppUrl = document.getElementById('webAppUrl').value.trim();
      if (!webAppUrl.includes('/exec')) {
        alert("Please paste the correct Web App URL ending in /exec");
        return;
      }

      const zip = new JSZip();

      const workerFile = config.advanced ? "worker_app_advanced.txt" : "worker_app_simple.txt";
      let workerHtml = await fetch(`${REPO_RAW}/${workerFile}?t=${Date.now()}`).then(r => r.text());

      // Inject all settings
      workerHtml = workerHtml
        .replace(/%%ORGANISATION_NAME%%/g, config.orgName)
        .replace(/%%ORS_API_KEY%%/g, config.orsKey)
        .replace(/%%GEMINI_API_KEY%%/g, config.geminiKey)
        .replace(/%%FIRST_ALERT_MINUTES%%/g, config.firstAlert)
        .replace(/%%ESCALATION_MINUTES%%/g, config.escalation)
        .replace(/%%CHECKIN_ENABLED%%/g, config.checkinEnabled ? "true" : "false")
        .replace(/%%CHECKIN_INTERVAL%%/g, config.checkinInterval)
        .replace(/%%WEB_APP_URL%%/g, webAppUrl);  // CRITICAL INJECTION

      zip.file("index.html", workerHtml);
      zip.file("monitor.html", await fetch(`${REPO_RAW}/monitor_app_template.txt?t=${Date.now()}`).then(r => r.text()));
      zip.file("manifest.json", await fetch(`${REPO_RAW}/manifest.json?t=${Date.now()}`).then(r => r.text()));
      zip.file("OTG_AppSuite_Documentation.pdf", await fetch("Templates/OTG_AppSuite_Documentation.pdf").then(r => r.blob()));

      finalZip = await zip.generateAsync({type: "blob"});
      showStep(6);

      document.getElementById('downloadBtn').onclick = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(finalZip);
        a.download = "OTG_AppSuite_Complete.zip";
        a.click();
      };
    }

    toggleAdvanced();
  </script>
</body>
</html>
