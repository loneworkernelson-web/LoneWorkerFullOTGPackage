<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>On-the-Go AppSuite - Setup Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    .step { display: none; }
    .step.active { display: block; }
    .step-nav button { @apply transition-all duration-200 px-4 py-2 text-sm font-medium rounded-md; }
    .step-nav button.current { @apply bg-blue-600 text-white font-semibold; }
    .copy-btn { @apply absolute top-3 right-3 bg-gray-600 text-white text-xs px-2 py-1 rounded hover:bg-gray-500 transition; }
    .copy-btn.copied { @apply bg-green-600; }
    .hidden-field { transition: all 0.4s ease; overflow: hidden; }
    .hidden-field.closed { opacity: 0; height: 0; margin: 0; padding: 0; }
    .logo-preview { max-width: 200px; max-height: 200px; border-radius: 0.5rem; }
    .upload-area { border: 2px dashed #4b5563; border-radius: 0.5rem; padding: 2rem; text-align: center; transition: all 0.2s; }
    .upload-area.dragover { border-color: #3b82f6; background: #1e293b; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-blue-400 mb-2">On-the-Go AppSuite</h1>
      <p class="text-xl text-gray-400">Complete Setup Wizard ‚Ä¢ November 2025</p>
    </div>

    <div class="step-nav flex flex-wrap justify-center gap-3 mb-10 bg-gray-800 p-4 rounded-xl shadow-lg">
      <button type="button" class="current" onclick="showStep(1)">1. Welcome</button>
      <button type="button" onclick="showStep(2)">2. Sheet Setup</button>
      <button type="button" onclick="showStep(3)">3. Configuration</button>
      <button type="button" onclick="showStep(4)">4. Deploy Script</button>
      <button type="button" onclick="showStep(5)">5. Logo & Finalize</button>
      <button type="button" onclick="showStep(6)">6. Done!</button>
    </div>

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12">
      <!-- Step 1: Welcome -->
      <div id="step1" class="step active space-y-10">
        <h2 class="text-3xl font-bold text-center text-blue-300">Welcome! Choose Your App Type</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <label class="block cursor-pointer">
            <input type="radio" name="appMode" value="simple" checked onchange="toggleAdvanced()" class="hidden peer">
            <div class="bg-gray-900 border-2 border-gray-700 rounded-xl p-8 text-center hover:border-blue-500 transition peer-checked:border-blue-500 peer-checked:bg-blue-900/20">
              <div class="text-6xl mb-4">üõ°Ô∏è</div>
              <h3 class="text-2xl font-bold">Simple App</h3>
              <p class="text-gray-400 mt-3">Safety-only ‚Ä¢ Timer ‚Ä¢ SOS ‚Ä¢ Duress PIN</p>
              <p class="text-green-400 font-bold mt-4">Most Popular</p>
            </div>
          </label>
          <label class="block cursor-pointer">
            <input type="radio" name="appMode" value="advanced" onchange="toggleAdvanced()" class="hidden peer">
            <div class="bg-gray-900 border-2 border-gray-700 rounded-xl p-8 text-center hover:border-blue-500 transition peer-checked:border-blue-500 peer-checked:bg-blue-900/20">
              <div class="text-6xl mb-4">üìä</div>
              <h3 class="text-2xl font-bold">Advanced App</h3>
              <p class="text-gray-400 mt-3">Full reporting ‚Ä¢ Photos ‚Ä¢ Gemini AI ‚Ä¢ Distance tracking</p>
              <p class="text-yellow-400 font-bold mt-4">Reporting Features</p>
            </div>
          </label>
        </div>
        <div class="text-center space-y-6">
          <a href="Templates/OTG_AppSuite_Documentation.pdf" target="_blank" class="inline-block bg-indigo-600 hover:bg-indigo-700 px-10 py-4 rounded-xl font-bold text-xl">
            Download Full Documentation (PDF)
          </a>
          <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 px-12 py-5 rounded-xl font-bold text-2xl ml-6">
            Start Setup ‚Üí
          </button>
        </div>
      </div>

      <!-- Step 2: Sheet Setup -->
      <div id="step2" class="step space-y-10">
        <h2 class="text-3xl font-bold text-center text-blue-300">Step 2: Set Up Your Google Sheet (Don't worry ‚Äî it's easy!)</h2>
        <div class="bg-yellow-900/30 border border-yellow-600 rounded-xl p-8 max-w-4xl mx-auto text-center">
          <p class="text-xl text-yellow-300 font-semibold">We'll do this together ‚Äî just follow the big buttons</p>
        </div>

        <div class="space-y-12 max-w-5xl mx-auto">
          <div class="bg-gray-900 rounded-xl p-8 border border-gray-700">
            <h3 class="text-2xl font-bold text-blue-400 mb-6">1. Create Your Google Sheet</h3>
            <div class="text-center">
              <a href="https://sheets.new" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 px-12 py-6 rounded-xl font-bold text-2xl">
                Click Here to Open Your New Sheet
              </a>
            </div>
          </div>

          <div class="bg-gray-900 rounded-xl p-8 border border-gray-700">
            <h3 class="text-2xl font-bold text-blue-400 mb-6">2. Set Up the "Visits" Tab</h3>
            <ol class="text-lg text-gray-300 space-y-5 list-decimal list-inside max-w-3xl mx-auto">
              <li>Rename bottom tab from "Sheet1" to <strong class="text-yellow-300">Visits</strong></li>
              <li>Click cell <strong>A1</strong></li>
              <li>Click <strong>Copy Visits Headers</strong> below ‚Üí paste with Ctrl+V</li>
            </ol>
            <div class="relative bg-gray-800 p-8 rounded-xl border border-gray-600 mt-8 font-mono text-sm">
              <button type="button" onclick="copyHeaders()" class="copy-btn text-lg px-4 py-2">Copy Visits Headers</button>
              <pre id="headers" class="text-gray-400 overflow-x-auto mt-4">Date,Worker Name,Worker Phone Number,Emergency Contact Name,Emergency Contact Number,Emergency Contact Email,Escalation Contact Name,Escalation Contact Number,Escalation Contact Email,Location Name,Location Address,Arrival Time,Anticipated Departure Time,Actual Departure Time,Alarm Status,Notes,Last Known GPS,GPS Timestamp,Battery Level</pre>
            </div>
          </div>

          <div id="checklistsSection" class="bg-gray-900 rounded-xl p-8 border border-gray-700 hidden">
            <h3 class="text-2xl font-bold text-yellow-300 mb-6">3. Set Up the "Checklists" Tab (Advanced Only)</h3>
            <ol class="text-lg text-gray-300 space-y-5 list-decimal list-inside max-w-3xl mx-auto">
              <li>Click the <strong>+</strong> at bottom-left to add new tab</li>
              <li>Rename it exactly: <strong class="text-yellow-300">Checklists</strong></li>
              <li>Click cell <strong>A1</strong> ‚Üí Copy headers below ‚Üí paste</li>
            </ol>
            <div class="relative bg-gray-800 p-8 rounded-xl border border-gray-600 mt-8 font-mono text-sm">
              <button type="button" onclick="copyChecklistsHeaders()" class="copy-btn text-lg px-4 py-2 bg-purple-600 hover:bg-purple-700">Copy Checklists Headers</button>
              <pre id="checklistsHeaders" class="text-gray-400 overflow-x-auto mt-4">Template Name,Question 1,Question 2,Question 3,Question 4,Question 5,Question 6,Question 7,Question 8,Question 9,Question 10,Question 11,Question 12,Question 13,Question 14,Question 15,Question 16,Question 17,Question 18,Question 19,Question 20,Question 21,Question 22,Question 23,Question 24,Question 25,Question 26,Question 27,Question 28,Question 29,Question 30,Question 31,Question 32,Question 33,Question 34,Question 35,Question 36,Question 37,Question 38,Question 39,Question 40</pre>
            </div>

            <div class="bg-indigo-900/50 border-2 border-indigo-500 rounded-2xl p-8 mt-10">
              <h4 class="text-2xl font-bold text-indigo-300 mb-6">Add Your Default Form</h4>
              <p class="text-lg text-gray-200">In the Checklists tab, type exactly this in cell <strong>A2</strong>:</p>
              <div class="bg-gray-800 rounded-xl p-6 text-center font-mono text-3xl text-green-400 my-6">
                (Standard)
              </div>
              <p class="text-green-400 font-bold text-xl text-center">This becomes the default form when no template is chosen</p>
            </div>
          </div>

          <div class="text-center pt-8">
            <button onclick="nextStep()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-20 py-8 rounded-xl font-bold text-3xl">
              I've Done This ‚Äî Next Step
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3: Configuration -->
      <div id="step3" class="step space-y-10">
        <h2 class="text-3xl font-bold text-center text-blue-300">Step 3: Your Settings</h2>
        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          <div><label class="block text-lg font-medium mb-2">Organisation Name</label><input id="orgName" value="My Company" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">Secret Key (Monitor Dashboard)</label><input id="secretKey" type="password" placeholder="Strong password" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">First Alert After (minutes)</label><input id="firstAlert" value="15" min="1" type="number" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">Escalation After (minutes)</label><input id="escalation" value="5" min="1" type="number" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div id="orsField" class="hidden-field closed"><label class="block text-lg font-medium mb-2 text-yellow-300">OpenRouteService API Key (Distance)</label><input id="orsKey" placeholder="Optional ‚Ä¢ openrouteservice.org" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div id="geminiField" class="hidden-field closed"><label class="block text-lg font-medium mb-2 text-yellow-300">Gemini API Key (AI Spellcheck)</label><input id="geminiKey" placeholder="Optional ‚Ä¢ aistudio.google.com" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div class="md:col-span-2">
            <label class="flex items-center space-x-4 text-lg">
              <input id="checkinEnabled" type="checkbox" class="h-6 w-6 text-blue-600">
              <span>Enable check-ins every</span>
              <input id="checkinInterval" value="30" min="5" type="number" class="w-24 px-4 py-3 bg-gray-700 rounded-lg mx-2">
              <span>minutes</span>
            </label>
          </div>
        </div>
        <div class="text-center">
          <button onclick="generateScriptAndProceed()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-16 py-6 rounded-xl font-bold text-2xl shadow-2xl transform hover:scale-105 transition">
            Generate Apps Script Code ‚Üí
          </button>
        </div>
      </div>

      <!-- Step 4: Deploy Script -->
      <div id="step4" class="step space-y-12">
        <h2 class="text-3xl font-bold text-center text-blue-300">Step 4: Deploy Your Google Apps Script</h2>
        <div class="bg-yellow-900/40 border-2 border-yellow-600 rounded-2xl p-10 text-center">
          <p class="text-2xl font-bold text-yellow-300">This is the last technical step ‚Äî we'll do it together!</p>
        </div>

        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700 space-y-8">
          <h3 class="text-2xl font-bold text-blue-400">1. Paste the Code</h3>
          <div class="text-center my-8">
            <a href="https://script.new" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 px-16 py-8 rounded-2xl font-bold text-3xl">
              Open script.new Now
            </a>
          </div>
          <div class="relative bg-gray-800 p-10 rounded-xl border border-gray-600 mt-8 font-mono text-sm">
            <button type="button" onclick="copyScript()" class="copy-btn text-lg px-6 py-3">Copy All Code</button>
            <pre id="scriptDisplay" class="text-left text-gray-400 overflow-x-auto h-96 mt-6"></pre>
          </div>
        </div>

        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700 space-y-8">
          <h3 class="text-2xl font-bold text-blue-400">2. Deploy as Web App (Exact Clicks)</h3>
          <ol class="text-lg text-gray-300 space-y-6 list-decimal list-inside max-w-4xl mx-auto">
            <li>Top-right ‚Üí click <strong>Deploy</strong> ‚Üí <strong>New deployment</strong></li>
            <li>Click <strong>Select type</strong> ‚Üí <strong>Web app</strong></li>
            <li>Set <strong>Who has access</strong> ‚Üí <strong>Anyone</strong></li>
            <li>Click <strong>Deploy</strong> ‚Üí Allow permissions when asked</li>
            <li>Copy the URL that ends in <strong>/exec</strong></li>
          </ol>
        </div>

        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700">
          <h3 class="text-2xl font-bold text-blue-400">3. Turn On 1-Minute Checks</h3>
          <p class="text-xl text-gray-300 text-center mb-6">This makes alerts work automatically</p>
          <ol class="text-lg text-gray-300 space-y-4 list-decimal list-inside max-w-3xl mx-auto">
            <li>Left sidebar ‚Üí click the clock icon (<strong>Triggers</strong>)</li>
            <li><strong>+ Add Trigger</strong> ‚Üí Function: <strong>checkOverdueWorkers</strong> ‚Üí Every 1 minute</li>
            <li><strong>Save</strong></li>
          </ol>
        </div>

        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700 text-center space-y-8">
          <h3 class="text-2xl font-bold text-green-400">4. Test It Live (5 Seconds)</h3>
          <input type="url" id="testUrl" placeholder="Your /exec URL will appear here when pasted" class="w-full max-w-3xl px-6 py-5 bg-gray-700 rounded-xl text-lg" readonly>
          <button onclick="runLiveTest()" class="mt-6 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-20 py-10 rounded-2xl font-bold text-3xl">
            Test Connection Now
          </button>
          <div id="testResult" class="mt-8 text-3xl font-bold"></div>
        </div>

        <div class="text-center pt-12">
          <button id="proceedBtn" onclick="nextStep()" disabled class="bg-green-600 opacity-50 px-24 py-12 rounded-2xl font-bold text-4xl cursor-not-allowed">
            All Connected! ‚Üí Next Step
          </button>
        </div>
      </div>

      <!-- Step 5: Logo & Finalize -->
      <div id="step5" class="step space-y-12">
        <h2 class="text-3xl font-bold text-center text-green-400">Connection Successful! üéâ</h2>
        <div class="bg-green-900/50 border-2 border-green-600 rounded-2xl p-10 text-center">
          <p class="text-2xl font-bold text-green-300">Your backend is ready and connected to your Google Sheet</p>
        </div>

        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700">
          <h3 class="text-2xl font-bold text-blue-400">Add Your Company Logo (Recommended)</h3>
          <p class="text-lg text-gray-300 mt-4">This will appear in the app header and PWA icon.</p>
          <div class="upload-area mt-6" id="logoUpload">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="mt-2 text-sm text-gray-500">PNG, JPG, or SVG (up to 500KB)</p>
            <input type="file" id="logoFile" accept="image/*,.svg" class="hidden">
            <button onclick="document.getElementById('logoFile').click()" class="mt-4 bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold text-white">
              Choose Logo File
            </button>
            <p class="mt-4 text-sm text-gray-400">Or drag & drop your logo here</p>
          </div>
          <div id="logoPreview" class="mt-8 hidden flex justify-center">
            <img id="logoImg" class="logo-preview shadow-lg" alt="Preview">
            <button onclick="clearLogo()" class="ml-4 bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm font-semibold text-white">Change Logo</button>
          </div>
          <div class="flex justify-center space-x-6 mt-8">
            <button onclick="skipLogo()" class="bg-gray-600 hover:bg-gray-700 px-8 py-4 rounded-xl font-bold text-lg">Skip ‚Äì Use Default</button>
            <button onclick="generatePackage()" id="finalizeBtn" disabled class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-8 py-4 rounded-xl font-bold text-lg">
              Generate My Apps
            </button>
          </div>
        </div>
      </div>

      <!-- Step 6: Success -->
     <div id="step6" class="step text-center py-20 space-y-12">
        <div class="text-9xl">Success!</div>
        <h2 class="text-5xl font-bold text-green-400">Your Complete App Package Is Ready!</h2>
        <p class="text-2xl text-gray-300 max-w-3xl mx-auto">Fully configured ‚Ä¢ Offline-ready ‚Ä¢ Includes backup script</p>
        <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 px-20 py-10 rounded-3xl font-bold text-4xl shadow-2xl transform hover:scale-110 transition">
          Download %%COMPANY_NAME%%_AppSuite.zip
        </button>
        <div class="mt-12 text-lg text-gray-400 space-y-2">
          <p>Included files:</p>
          <ul class="text-green-400 font-mono text-sm">
            <li>index.html ‚Äì Your worker app</li>
            <li>manifest.json ‚Äì With your logo & name</li>
            <li>sw.js ‚Äì Offline + instant loading</li>
            <li>OTG_Backend_Script.gs ‚Äì Full Apps Script backup</li>
            <li>OTG_AppSuite_Documentation.pdf</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const REPO = "https://raw.githubusercontent.com/loneworkernelson-web/LoneWorkerFullOTGPackage/main/Templates";
    let currentStep = 1, zip, logoBlob = null, finalScriptCode = "";

    function showStep(n) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + n).classList.add('active');
      document.querySelectorAll('.step-nav button').forEach((b, i) => b.classList.toggle('current', i + 1 === n));
      currentStep = n;
      if (n === 1) toggleAdvanced();
    }

    function nextStep() { showStep(currentStep + 1); }

    function copyHeaders() {
      navigator.clipboard.writeText(document.getElementById('headers').textContent);
      const btn = document.querySelector('#step2 .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy Visits Headers'; btn.classList.remove('copied'); }, 2000);
    }

    function copyChecklistsHeaders() {
      navigator.clipboard.writeText(document.getElementById('checklistsHeaders').textContent);
      const btn = document.querySelector('#checklistsSection .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy Checklists Headers'; btn.classList.remove('copied'); }, 2000);
    }

    function toggleAdvanced() {
      const adv = document.querySelector('input[value="advanced"]').checked;
      document.getElementById('checklistsSection').classList.toggle('hidden', !adv);
      document.querySelectorAll('.hidden-field').forEach(el => el.classList.toggle('closed', !adv));
    }

    async function generateScriptAndProceed() {
      const config = {
        SECRET_KEY: document.getElementById('secretKey').value || "changeme123",
        VISITS_SHEET_NAME: "Visits",
        CHECKLISTS_SHEET_NAME: "Checklists",
        ESCALATION_MINUTES: document.getElementById('escalation').value,
        FIRST_ALERT_MINUTES: document.getElementById('firstAlert').value,
        PHOTOS_FOLDER_ID: "%%PHOTOS_FOLDER_ID%%" // Optional ‚Äì set up later
      };

      const template = await fetch(`${REPO}/apps_script_advanced.txt`).then(r => r.text());
      const script = template
        .replace(/%%SECRET_KEY%%/g, config.SECRET_KEY)
        .replace(/%%VISITS_SHEET_NAME%%/g, config.VISITS_SHEET_NAME)
        .replace(/%%CHECKLISTS_SHEET_NAME%%/g, config.CHECKLISTS_SHEET_NAME)
        .replace(/%%ESCALATION_MINUTES%%/g, config.ESCALATION_MINUTES)
        .replace(/%%FIRST_ALERT_MINUTES%%/g, config.FIRST_ALERT_MINUTES);

      document.getElementById('scriptDisplay').textContent = script;
      showStep(4);
    }

    function copyScript() {
      navigator.clipboard.writeText(document.getElementById('scriptDisplay').textContent);
      const btn = document.querySelector('#step4 .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy All Code'; btn.classList.remove('copied'); }, 2000);
    }

    document.addEventListener('paste', (e) => {
      const text = (e.clipboardData || window.clipboardData).getData('text');
      if (text.includes('/exec')) {
        document.getElementById('testUrl').value = text;
      }
    });

    async function runLiveTest() {
      const url = document.getElementById('testUrl').value.trim();
      const result = document.getElementById('testResult');
      const btn = document.getElementById('proceedBtn');
      if (!url.includes('/exec')) { result.innerHTML = "Paste your /exec URL first"; return; }

      result.textContent = "Testing...";
      try {
        const resp = await fetch(`${url}?test=1&key=${encodeURIComponent(document.getElementById('secretKey').value)}`);
        const text = await resp.text();
        if (text.includes("OTG_SUCCESS")) {
          result.innerHTML = "Perfect! Everything is connected! üéâ";
          btn.disabled = false;
          btn.className = "bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-24 py-12 rounded-2xl font-bold text-4xl cursor-pointer";
          document.getElementById('webAppUrl').value = url;
          document.getElementById('testUrl').readOnly = true;
          nextStep();
        } else {
          result.innerHTML = "Failed ‚Äì check secret key";
        }
      } catch (e) {
        result.innerHTML = "Connection failed ‚Äì double-check URL";
      }
    }

    function skipLogo() {
      logoBlob = null;
      document.getElementById('logoUpload').classList.remove('hidden');
      document.getElementById('logoPreview').classList.add('hidden');
      document.getElementById('finalizeBtn').disabled = false;
      document.getElementById('finalizeBtn').textContent = "Generate My Apps";
    }

    function clearLogo() {
      logoBlob = null;
      document.getElementById('logoFile').value = '';
      document.getElementById('logoImg').src = '';
      document.getElementById('logoPreview').classList.add('hidden');
      document.getElementById('logoUpload').classList.remove('hidden');
    }

    document.getElementById('logoFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file || file.size > 500000) {
        alert("Please choose a file under 500KB (PNG, JPG, or SVG)");
        return;
      }
      const reader = new FileReader();
      reader.onload = (evt) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const size = Math.max(img.width, img.height);
          canvas.width = canvas.height = 512;
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, 512, 512);
          ctx.drawImage(img, (512-size)/2, (512-size)/2, size, size);
          canvas.toBlob(blob => {
            logoBlob = blob;
            document.getElementById('logoImg').src = URL.createObjectURL(blob);
            document.getElementById('logoPreview').classList.remove('hidden');
            document.getElementById('logoUpload').classList.add('hidden');
            document.getElementById('finalizeBtn').disabled = false;
          }, 'image/png');
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Drag & drop
    document.getElementById('logoUpload').addEventListener('dragover', e => {
      e.preventDefault();
      e.currentTarget.classList.add('dragover');
    });
    document.getElementById('logoUpload').addEventListener('dragleave', e => {
      e.currentTarget.classList.remove('dragover');
    });
    document.getElementById('logoUpload').addEventListener('drop', e => {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      document.getElementById('logoFile').files = e.dataTransfer.files;
      document.getElementById('logoFile').dispatchEvent(new Event('change'));
    });

    async function generatePackage() {
      const isAdv = document.querySelector('input[value="advanced"]').checked;
      const orgName = document.getElementById('orgName').value || "My Company";
      const config = {
        COMPANY_NAME: orgName,
        SECRET_KEY: document.getElementById('secretKey').value || "changeme123",
        FIRST_ALERT_MINUTES: document.getElementById('firstAlert').value,
        ESCALATION_MINUTES: document.getElementById('escalation').value,
        CHECKIN_ENABLED: document.getElementById('checkinEnabled').checked,
        CHECKIN_INTERVAL: document.getElementById('checkinInterval').value,
        ORS_KEY: document.getElementById('orsKey').value,
        GEMINI_KEY: document.getElementById('geminiKey').value,
        WEB_APP_URL: document.getElementById('testUrl').value.trim()
      };

      zip = new JSZip();

      try {
        // Worker App (Advanced or Simple)
        const workerTemplate = await fetch(`${REPO}/${isAdv ? 'worker_app_advanced.txt' : 'worker_app_simple.txt'}`).then(r => r.text());
        let workerHtml = workerTemplate;
        for (const key in config) {
          workerHtml = workerHtml.replace(new RegExp(`%%${key}%%`, 'g'), config[key]);
        }

        // Logo handling
        let logoDataUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGAoQ0d1gAAAABJRU5ErkJggg=="; // 1x1 transparent
        if (logoBlob) {
          logoDataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(logoBlob);
          });
        }
        workerHtml = workerHtml.replace(/%%LOGO_URL%%/g, logoDataUrl).replace(/%%FAVICON_URL%%/g, logoDataUrl);

        // manifest.json ‚Äì fully dynamic
        const manifest = {
          "name": orgName + " On-the-Go",
          "short_name": orgName,
          "description": "Lone worker safety & reporting app",
          "start_url": "/index.html",
          "display": "standalone",
          "background_color": "#111827",
          "theme_color": "#1e40af",
          "icons": [
            {"src": logoDataUrl, "sizes": "512x512", "type": "image/png", "purpose": "maskable any"}
          ]
        };

        // Add all files
        zip.file("index.html", workerHtml);
        zip.file("manifest.json", JSON.stringify(manifest, null, 2));
        zip.file("sw.js", await fetch(`${REPO}/sw.js`).then(r => r.text()));
        zip.file("OTG_Backend_Script.gs", finalScriptCode || document.getElementById('scriptDisplay').textContent);
        zip.file("OTG_AppSuite_Documentation.pdf", await fetch("Templates/OTG_AppSuite_Documentation.pdf").then(r => r.blob()));

        const finalBlob = await zip.generateAsync({type: "blob"});
        showStep(6);
        document.getElementById('downloadBtn').textContent = `Download ${orgName}_AppSuite.zip`;
        document.getElementById('downloadBtn').onclick = () => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(finalBlob);
          a.download = `${orgName.replace(/[^a-zA-Z0-9]/g,'_')}_AppSuite.zip`;
          a.click();
        };
      } catch (err) {
        console.error(err);
        alert("Package generation failed: " + err.message);
      }
    }

    // Save script code when generated
    async function generateScriptAndProceed() {
      // ... existing code ...
      const script = template
        .replace(/%%SECRET_KEY%%/g, config.SECRET_KEY)
        .replace(/%%VISITS_SHEET_NAME%%/g, config.VISITS_SHEET_NAME)
        .replace(/%%CHECKLISTS_SHEET_NAME%%/g, config.CHECKLISTS_SHEET_NAME)
        .replace(/%%ESCALATION_MINUTES%%/g, config.ESCALATION_MINUTES)
        .replace(/%%FIRST_ALERT_MINUTES%%/g, config.FIRST_ALERT_MINUTES);

      finalScriptCode = script;  // ‚Üê This saves it for backup
      document.getElementById('scriptDisplay').textContent = script;
      showStep(4);
    }
    async function finalizeWithWebAppUrl() {
      const webAppUrl = document.getElementById('webAppUrl').value.trim();
      if (!webAppUrl.includes('/exec')) { alert("Please complete the test first"); return; }

      const zip = new JSZip();
      const workerFile = config.advanced ? "worker_app_advanced.txt" : "worker_app_simple.txt";
      let workerHtml = await fetch(`${REPO_RAW}/${workerFile}?t=${Date.now()}`).then(r => r.text());

      workerHtml = workerHtml
        .replace(/%%ORGANISATION_NAME%%/g, config.orgName)
        .replace(/%%ORS_API_KEY%%/g, config.orsKey)
        .replace(/%%GEMINI_API_KEY%%/g, config.geminiKey)
        .replace(/%%FIRST_ALERT_MINUTES%%/g, config.firstAlert)
        .replace(/%%ESCALATION_MINUTES%%/g, config.escalation)
        .replace(/%%WEB_APP_URL%%/g, webAppUrl);

      zip.file("index.html", workerHtml);
      zip.file("monitor.html", await fetch(`${REPO_RAW}/monitor_app_template.txt?t=${Date.now()}`).then(r => r.text()));
      zip.file("manifest.json", await fetch(`${REPO_RAW}/manifest.json?t=${Date.now()}`).then(r => r.text()));
      zip.file("OTG_AppSuite_Documentation.pdf", await fetch("Templates/OTG_AppSuite_Documentation.pdf").then(r => r.blob()));

      finalZip = await zip.generateAsync({type: "blob"});
      showStep(6);
      document.getElementById('downloadBtn').onclick = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(finalZip);
        a.download = "OTG_AppSuite_Complete.zip";
        a.click();
      };
    }
    toggleAdvanced();
  </script>
</body>
</html>
