<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>On-the-Go AppSuite - Setup Tool</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    *,::before,::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:#0f172a;color:#e2e8f0;line-height:1.6;min-height:100vh;}
    .container{max-width:1280px;margin:auto;padding:1.5rem}
    .bg-gray-900{background:#0f172a}.bg-gray-800{background:#1e293b}.bg-gray-700{background:#334155}
    .text-blue-400{color:#38bdf8}.text-green-400{color:#34d399}.text-yellow-300{color:#fde047}.text-purple-400{color:#c084fc}
    .text-gray-300{color:#cbd5e1}.text-gray-400{color:#94a3b8}
    .btn-primary{background:linear-gradient(to right,#16a34a,#10b981);color:white;font-weight:700;padding:1rem 2rem;border-radius:1rem;transition:all .2s;box-shadow:0 10px 25px -5px rgba(16,185,129,0.4);}
    .btn-primary:hover{background:linear-gradient(to right,#15803d,#059669);transform:translateY(-2px);box-shadow:0 15px 30px -5px rgba(16,185,129,0.5);}
    .btn-large{padding:1.5rem 3rem;font-size:1.75rem;border-radius:1.25rem;}
    .btn-xl{padding:2rem 4rem;font-size:2.5rem;border-radius:1.5rem;}
    .nav-btn{padding:0.75rem 1.5rem;border-radius:0.75rem;font-weight:700;background:#1e293b;border:1px solid #334155;color:#e2e8f0;}
    .nav-btn.current{background:#2563eb;color:white;border-color:#2563eb;font-weight:900;}
    .hidden-field{height:0;opacity:0;overflow:hidden;transition:all .4s ease;}
    .hidden-field.open{height:auto;opacity:1;padding-top:1rem;margin-top:1rem;}
    .step{display:none !important;}.step.active{display:block !important;}
    .huge-copy-btn{font-size:2rem !important;padding:1.75rem 5rem !important;border-radius:9999px !important;font-weight:900 !important;
      background:linear-gradient(to right,#10b981,#059669) !important;border:5px solid rgba(255,255,255,0.35) !important;
      box-shadow:0 20px 40px -10px rgba(0,0,0,0.6) !important;color:white !important;display:block;margin:2rem auto;}
    .huge-copy-btn:hover{transform:scale(1.08) !important;}
    .huge-copy-btn.purple{background:linear-gradient(to right,#c084fc,#ec4899) !important;}
    .huge-copy-btn.cyan{background:linear-gradient(to right,#06b6d4,#3b82f6) !important;}
    .huge-copy-btn::selection,.huge-copy-btn *::selection{background:#fff !important;color:#000 !important;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Shield</text></svg>">
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container">
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold text-blue-400 mb-2">On-the-Go AppSuite</h1>
      <p class="text-xl text-gray-400">Full Production Setup Wizard • November 2025</p>
    </div>

    <div class="flex flex-wrap justify-center gap-3 mb-10 bg-gray-800 p-4 rounded-xl shadow-2xl">
      <button type="button" class="nav-btn current" onclick="showStep(1)">1. Welcome</button>
      <button type="button" class="nav-btn" onclick="showStep(2)">2. Sheet Setup</button>
      <button type="button" class="nav-btn" onclick="showStep(3)">3. Settings</button>
      <button type="button" class="nav-btn" onclick="showStep(4)">4. Deploy Script</button>
      <button type="button" class="nav-btn" onclick="showStep(5)">5. Branding</button>
      <button type="button" class="nav-btn" onclick="showStep(6)">6. Done!</button>
    </div>

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8">
      <!-- STEP 1 -->
      <div id="step1" class="step active space-y-10">
        <h2 class="text-4xl font-bold text-center text-blue-300">Welcome! Choose Your App Type</h2>
        <div class="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto">
          <label class="block cursor-pointer"><input type="radio" name="appMode" value="simple" checked class="hidden" onchange="toggleAdvanced()">
            <div class="bg-gray-900 border-4 border-gray-700 rounded-3xl p-12 text-center hover:border-blue-500 transition-all"><div class="text-9xl mb-6">Shield</div><h3 class="text-4xl font-bold mb-4">Simple App</h3><p class="text-2xl text-green-400 font-bold">Most Popular</p></div>
          </label>
          <label class="block cursor-pointer"><input type="radio" name="appMode" value="advanced" class="hidden" onchange="toggleAdvanced()">
            <div class="bg-gray-900 border-4 border-gray-700 rounded-3xl p-12 text-center hover:border-yellow-500 transition-all"><div class="text-9xl mb-6">Tools</div><h3 class="text-4xl font-bold mb-4">Advanced App</h3><p class="text-2xl text-yellow-400 font-bold">Full Reporting + AI</p></div>
          </label>
        </div>
        <div class="text-center mt-12"><button onclick="nextStep()" class="btn-primary btn-xl">Continue → Start Setup</button></div>
      </div>

      <!-- STEP 2 -->
      <div id="step2" class="step space-y-16 max-w-5xl mx-auto">
        <h2 class="text-4xl font-bold text-center text-blue-300">Step 2: Set Up Your Google Sheet</h2>
        <p class="text-center text-xl text-gray-400">Just follow the 3–4 giant buttons below — takes 60 seconds</p>
        <div class="text-center">
          <a href="https://sheets.new" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold text-3xl px-20 py-8 rounded-2xl shadow-2xl">1. Open New Google Sheet</a>
        </div>

        <div class="bg-gray-900 rounded-3xl p-12 border-2 border-gray-700 text-center space-y-8">
          <h3 class="text-3xl font-bold text-blue-400">2. Set up the “Visits” tab</h3>
          <p class="text-xl text-gray-300">Rename tab → <strong>Visits</strong> → click A1 → click button → Ctrl+V</p>
          <button type="button" onclick="copyHeaders()" class="huge-copy-btn">Copy Visits Headers → Paste in A1</button>
        </div>

        <div id="checklistsSection" class="bg-gray-900 rounded-3xl p-12 border-2 border-gray-700 text-center space-y-10 hidden">
          <h3 class="text-3xl font-bold text-purple-400">3. Set up the “Checklists” tab</h3>
          <p class="text-xl text-gray-300">Add tab → name <strong>Checklists</strong> → click A1 → click button → Ctrl+V</p>
          <button type="button" onclick="copyChecklistsHeaders()" class="huge-copy-btn purple">Copy Checklists Headers → Paste in A1</button>

          <div class="mt-12 p-12 bg-gradient-to-r from-emerald-900/70 to-cyan-900/70 rounded-3xl border-3 border-emerald-500">
            <h4 class="text-3xl font-bold text-emerald-300 mb-6">One-Click Starter Templates</h4>
            <p class="text-xl text-gray-200 mb-8">Click below → paste starting at <strong>cell A2</strong><br>Includes (Standard) + required Travel Details + two demo templates</p>
            <button type="button" onclick="copyStarterTemplates()" class="huge-copy-btn bg-gradient-to-r from-emerald-500 to-cyan-600 hover:from-emerald-600 hover:to-cyan-700 text-white font-bold text-2xl px-32 py-9">
              Copy Starter Templates → Paste at A2
            </button>
            <pre class="mt-10 bg-gray-800/80 rounded-2xl p-8 text-left text-sm font-mono text-gray-300 max-w-5xl mx-auto border border-gray-600">(Standard)	Arrival notes	[TEXT]
(Standard)	Site photo	[PHOTO]
(Standard)	Sign in	[SIGN]

Travel Details	Distance travelled (km)	[NUMBER]
Travel Details	Travel notes	[TEXT]

(Daily Safety Check)	Are you wearing PPE?	[YESNO]
(Daily Safety Check)	Fire exits clear?	[CHECK]
(Daily Safety Check)	Safety photo	[PHOTO]

(Vehicle Inspection)	Oil level OK?	[YESNO]
(Vehicle Inspection)	Tyres pressure	[NUMBER]
(Vehicle Inspection)	Damage photo (if any)	[PHOTO?]
(Vehicle Inspection)	Driver signature	[SIGN]</pre>
            <div class="mt-8 p-6 bg-emerald-900/50 rounded-2xl border border-emerald-400">
              <p class="text-emerald-200 text-lg font-bold">What you get instantly:</p>
              <ul class="text-left mt-4 space-y-2 text-gray-200">
                <li>• <strong>(Standard)</strong> – default form on every visit</li>
                <li>• <strong>Travel Details</strong> – auto-opens when worker taps “Travelling” (required for mileage)</li>
                <li>• Two demo checklists to impress your team</li>
              </ul>
            </div>
          </div>

          <button type="button" onclick="copyPermanentReference()" class="huge-copy-btn cyan mt-12">Optional: Copy Full Code Legend → Paste at A20</button>
        </div>

        <div class="text-center pt-12">
          <button onclick="nextStep()" class="btn-primary btn-xl">I’ve Set Up My Sheet — Next Step →</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div id="step3" class="step space-y-10">
        <h2 class="text-4xl font-bold text-center text-blue-300">Step 3: Your Settings</h2>
        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          <div><label class="block text-lg font-medium mb-2">Organisation Name</label><input type="text" id="orgName" value="My Company" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">Secret Key</label><input type="password" id="secretKey" value="changeme123" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">First Alert (minutes)</label><input type="number" id="firstAlert" value="15" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">Escalation (minutes)</label><input type="number" id="escalation" value="5" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div id="orsField" class="hidden-field"><label class="block text-lg font-medium mb-2 text-yellow-300">OpenRouteService Key (optional)</label><input type="text" id="orsKey" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div id="geminiField" class="hidden-field"><label class="block text-lg font-medium mb-2 text-yellow-300">Gemini API Key (optional)</label><input type="text" id="geminiKey" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
        </div>
        <div class="text-center">
          <button onclick="generateScriptAndProceed()" class="btn-primary btn-large">Generate Code → Go to Step 4</button>
        </div>
      </div>

      <!-- STEP 4 – Deploy Script -->
      <div id="step4" class="step space-y-12">
        <h2 class="text-4xl font-bold text-center text-blue-300">Step 4: Connect Your Google Sheet</h2>
        <div class="bg-yellow-900/40 border-2 border-yellow-600 rounded-2xl p-10 text-center">
          <p class="text-2xl font-bold text-yellow-300">Last technical step — we’ll do it together!</p>
        </div>

        <!-- 1. Paste code -->
        <div class="bg-gray-900 rounded-3xl p-12 border-2 border-gray-700 space-y-8">
          <h3 class="text-3xl font-bold text-blue-400">1. Paste the Apps Script code</h3>
          <div class="text-center my-10">
            <a href="https://script.new" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold text-3xl px-20 py-8 rounded-2xl shadow-2xl">
              Open script.new Now
            </a>
          </div>
          <pre id="scriptDisplay" class="bg-gray-800/80 rounded-2xl p-8 text-left text-sm overflow-x-auto h-96 border border-gray-600"></pre>
          <div class="text-center mt-8">
            <button type="button" onclick="copyScript()" class="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white font-bold text-3xl px-24 py-8 rounded-full shadow-2xl transform hover:scale-105 transition-all border-4 border-white/30">
              Copy Full Script Code to Clipboard
            </button>
          </div>
        </div>

        <!-- 2. Deploy + 3. Triggers -->
        <div class="grid md:grid-cols-2 gap-10">
          <div class="bg-gray-900 rounded-3xl p-10 border-2 border-gray-700">
            <h3 class="text-2xl font-bold text-blue-400 mb-6">2. Deploy as Web App</h3>
            <ol class="text-lg text-gray-300 space-y-4 list-decimal list-inside">
              <li>Click <strong>Deploy → New deployment</strong></li>
              <li>Select type → <strong>Web app</strong></li>
              <li>Who has access → <strong>Anyone</strong></li>
              <li>Click <strong>Deploy</strong> → Allow permissions</li>
              <li>Copy the URL ending in <strong>/exec</strong></li>
            </ol>
          </div>
          <div class="bg-gray-900 rounded-3xl p-10 border-2 border-gray-700">
            <h3 class="text-2xl font-bold text-blue-400 mb-6">3. Enable 1-minute checks</h3>
            <ol class="text-lg text-gray-300 space-y-4 list-decimal list-inside">
              <li>Left sidebar → clock icon (<strong>Triggers</strong>)</li>
              <li><strong>+ Add Trigger</strong></li>
              <li>Function: <strong>checkOverdueWorkers</strong></li>
              <li>Event: <strong>Time-driven → Minutes timer → Every 1 minute</strong></li>
              <li>Save</li>
            </ol>
          </div>
        </div>

        <!-- Live test -->
        <div class="bg-gray-900 rounded-3xl p-12 border-2 border-gray-700 text-center space-y-8">
          <h3 class="text-3xl font-bold text-green-400">4. Live Connection Test</h3>
          <input type="url" id="testUrl" placeholder="Paste your /exec URL here" class="w-full max-w-3xl px-6 py-5 bg-gray-700 rounded-xl text-lg text-center">
          <button onclick="runLiveTest()" class="btn-primary btn-large mt-6">Test Connection Now</button>
          <div id="testResult" class="mt-8 text-3xl font-bold"></div>
        </div>

        <div class="text-center pt-12">
          <button id="proceedBtn" onclick="nextStep()" disabled class="btn-primary btn-xl opacity-60 cursor-not-allowed">
            All Connected! → Next Step
          </button>
        </div>
      </div>

      <!-- STEP 5 – Branding & Logo -->
      <div id="step5" class="step space-y-12 text-center">
        <h2 class="text-4xl font-bold text-blue-300">Step 5: Branding & Finalize</h2>
        <div class="max-w-3xl mx-auto bg-gray-900 p-10 rounded-3xl border-2 border-gray-700">
          <p class="text-xl text-gray-300 mb-4">Your Web App URL is ready:</p>
          <input type="url" id="webAppUrl" class="w-full px-6 py-5 bg-gray-700 rounded-xl text-lg text-center font-mono" readonly>
        </div>

        <div class="max-w-2xl mx-auto">
          <label class="block text-2xl font-bold mb-6 text-yellow-300">Upload Company Logo (optional)</label>
          <div id="dropZone" class="upload-area border-4 border-dashed border-gray-600 rounded-3xl p-16 cursor-pointer hover:border-blue-500 transition-all">
            <p class="text-2xl text-gray-400">Drag & drop or click to upload</p>
            <p class="text-gray-500 mt-2">(Used for app icon & favicon)</p>
            <input type="file" id="logoInput" accept="image/*" class="hidden">
            <img id="logoPreview" class="mt-6 max-h-48 mx-auto hidden rounded-xl">
          </div>
        </div>

        <button onclick="generatePackage()" class="btn-primary btn-xl mt-12">
          Generate Final App Package
        </button>
      </div>

      <!-- STEP 6 – Done! -->
      <div id="step6" class="step text-center py-20 space-y-12">
        <div class="text-9xl">Success!</div>
        <h2 class="text-6xl font-bold text-green-400">Your AppSuite is Ready!</h2>
        <p class="text-2xl text-gray-300 max-w-4xl mx-auto">Offline-ready • Fully configured • Includes backup script & monitor dashboard</p>
        
        <button id="downloadBtn" class="btn-primary btn-xl">
          Download AppSuite.zip
        </button>

        <div class="mt-16 grid md:grid-cols-3 gap-8 max-w-5xl mx-auto text-left">
          <div class="bg-gray-900 rounded-2xl p-8 border border-gray-700">
            <h4 class="text-xl font-bold text-blue-400 mb-4">Worker App</h4>
            <ul class="text-green-400 space-y-2">✓ index.html<br>✓ manifest.json<br>✓ sw.js (offline)</ul>
          </div>
          <div class="bg-gray-900 rounded-2xl p-8 border border-gray-700">
            <h4 class="text-xl font-bold text-purple-400 mb-4">Monitor Dashboard</h4>
            <ul class="text-green-400 space-y-2">✓ monitor.html<br>✓ Real-time alerts</ul>
          </div>
          <div class="bg-gray-900 rounded-2xl p-8 border border-gray-700">
            <h4 class="text-xl font-bold text-yellow-400 mb-4">Backup & Docs</h4>
            <ul class="text-green-400 space-y-2">✓ OTG_Backend_Script.gs<br>✓ Documentation.pdf</ul>
          </div>
        </div>
      </div>
  </div>

<script>
  const REPO = "https://raw.githubusercontent.com/loneworkernelson-web/LoneWorkerFullOTGPackage/main/Templates";
  let config = {};
  let finalScriptCode = "";
  let logoBlob = null;
  let zip;

  // ────────────────────── SELECTION LOGIC ──────────────────────
  function toggleAdvanced() {
    const isAdvanced = document.querySelector('input[name="appMode"]:checked').value === "advanced";
    document.getElementById('checklistsSection')?.classList.toggle('hidden', !isAdvanced);
    document.querySelectorAll('.hidden-field').forEach(el => el.classList.toggle('open', isAdvanced));
  }

  function updateSelection() {
    const selected = document.querySelector('input[name="appMode"]:checked').value;
    document.querySelectorAll('.select-card').forEach(card => {
      card.classList.toggle('selected', card.dataset.mode === selected);
    });
    toggleAdvanced();
  }

  document.querySelectorAll('input[name="appMode"]').forEach(radio => {
    radio.addEventListener('change', updateSelection);
  });
  document.addEventListener('DOMContentLoaded', updateSelection);

  // ────────────────────── NAVIGATION – FIXED & BULLETPROOF ──────────────────────
  function showStep(n) {
    // Hide all steps, show only the requested one
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + n)?.classList.add('active');

    // Update navigation bar highlighting – now uses .nav-btn
    document.querySelectorAll('.nav-btn').forEach((btn, i) => {
      btn.classList.toggle('current', i + 1 === n);
    });
  }

  function nextStep() {
    const current = document.querySelector('.nav-btn.current');
    if (!current) return;
    const nextNum = Array.from(document.querySelectorAll('.nav-btn')).indexOf(current) + 2; // +2 because index starts at 0 and we want next step
    if (nextNum <= 6) showStep(nextNum);
  }
// ────────────────────── REAL TAB-SEPARATED COPY FUNCTIONS ──────────────────────
  function copyHeaders() {
    const headers = "Date\tWorker Name\tWorker Phone Number\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email\tLocation Name\tLocation Address\tArrival Time\tAnticipated Departure Time\tActual Departure Time\tAlarm Status\tNotes\tLast Known GPS\tGPS Timestamp\tBattery Level";
    navigator.clipboard.writeText(headers);
    alert("Visits headers copied (tabs included)!");
  }
  function copyChecklistsHeaders() {
    const h = "Template Name\tQuestion 1\tQuestion 2\tQuestion 3\tQuestion 4\tQuestion 5\tQuestion 6\tQuestion 7\tQuestion 8\tQuestion 9\tQuestion 10\tQuestion 11\tQuestion 12\tQuestion 13\tQuestion 14\tQuestion 15\tQuestion 16\tQuestion 17\tQuestion 18\tQuestion 19\tQuestion 20\tQuestion 21\tQuestion 22\tQuestion 23\tQuestion 24\tQuestion 25\tQuestion 26\tQuestion 27\tQuestion 28\tQuestion 29\tQuestion 30\tQuestion 31\tQuestion 32\tQuestion 33\tQuestion 34\tQuestion 35\tQuestion 36\tQuestion 37\tQuestion 38\tQuestion 39\tQuestion 40";
    navigator.clipboard.writeText(h);
    alert("Checklists headers copied!");
  }
  function copyStarterTemplates() {
    const t = `(Standard)\tArrival notes\t[TEXT]
(Standard)\tSite photo\t[PHOTO]
(Standard)\tSign in\t[SIGN]

Travel Details\tDistance travelled (km)\t[NUMBER]
Travel Details\tTravel notes\t[TEXT]

(Daily Safety Check)\tAre you wearing PPE?\t[YESNO]
(Daily Safety Check)\tFire exits clear?\t[CHECK]
(Daily Safety Check)\tSafety photo\t[PHOTO]

(Vehicle Inspection)\tOil level OK?\t[YESNO]
(Vehicle Inspection)\tTyres pressure\t[NUMBER]
(Vehicle Inspection)\tDamage photo (if any)\t[PHOTO?]
(Vehicle Inspection)\tDriver signature\t[SIGN]`;
    navigator.clipboard.writeText(t);
    alert("Starter templates copied!\n\nPaste starting at A2 in Checklists tab — perfect layout guaranteed");
  }

  // ────────────────────── LOGO UPLOAD ──────────────────────
  const dropZone = document.getElementById('dropZone');
  const logoInput = document.getElementById('logoInput');
  const logoPreview = document.getElementById('logoPreview');

  dropZone.addEventListener('click', () => logoInput.click());
  logoInput.addEventListener('change', e => handleFile(e));
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleFile({target: {files: e.dataTransfer.files}});
  });

  function handleFile(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      logoBlob = file;
      const reader = new FileReader();
      reader.onload = ev => {
        logoPreview.src = ev.target.result;
        logoPreview.classList.remove('hidden');
        dropZone.querySelector('p').textContent = "Logo Loaded!";
      };
      reader.readAsDataURL(file);
    }
  }

  // ────────────────────── SCRIPT GENERATION & DEPLOY ──────────────────────
  async function generateScriptAndProceed() {
  config = {
    orgName: document.getElementById('orgName').value || "My Company",
    secretKey: document.getElementById('secretKey').value || "changeme123",
    firstAlert: document.getElementById('firstAlert').value,
    escalation: document.getElementById('escalation').value,
    orsKey: document.getElementById('orsKey').value,
    geminiKey: document.getElementById('geminiKey').value,
    advanced: document.querySelector('input[value="advanced"]').checked
  };

  const template = await fetch(`${REPO}/apps_script_advanced.txt?t=${Date.now()}`).then(r => r.text());
  finalScriptCode = template
    .replace(/%%SECRET_KEY%%/g, config.secretKey)
    .replace(/%%FIRST_ALERT_MINUTES%%/g, config.firstAlert)
    .replace(/%%ESCALATION_MINUTES%%/g, config.escalation)
    .replace(/%%ORS_API_KEY%%/g, config.orsKey)
    .replace(/%%GEMINI_API_KEY%%/g, config.geminiKey);

  document.getElementById('scriptDisplay').textContent = finalScriptCode;
  showStep(4);  // ← this line jumps to Step 4 with the full script ready
}
  function copyScript() {
    navigator.clipboard.writeText(finalScriptCode || document.getElementById('scriptDisplay').textContent);
    alert('Full script copied! Paste it in script.new');
  }

  // ────────────────────── LIVE TEST ──────────────────────
 async function runLiveTest() {
  const url = document.getElementById('testUrl').value.trim();
  const result = document.getElementById('testResult');
  const btn = document.getElementById('proceedBtn');
  if (!url.includes('/exec')) { result.textContent = "Paste your /exec URL first"; return; }
  result.textContent = "Testing...";
  try {
    const resp = await fetch(`${url}?test=1&key=${encodeURIComponent(config.secretKey)}`, {
      mode: 'no-cors'  // ← CORS-proof
    });
    if (resp) {  // ← Success if fetch worked (no-cors always "succeeds" if URL is valid)
      result.innerHTML = "Perfect! Connected!";
      btn.disabled = false;
      btn.className = "bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-24 py-12 rounded-2xl font-bold text-4xl cursor-pointer";
      document.getElementById('webAppUrl').value = url;
    } else {
      result.innerHTML = "Failed — check URL";
    }
  } catch (e) {
    result.innerHTML = "Connection error — check URL format";
  }
}
// ────────────────────── Copy Legend ──────────────────────
function copyPermanentReference() {
  const ref = `Checklist Template Codes – Permanent Reference,,,
[HEADING],Large bold section title,Example: Daily Safety Check,[HEADING]
[NOTE],Small italic instruction,Example: Only fill if applicable,[NOTE]
[TEXT],Multi-line text box (default),,
[NUMBER],Number only,Example: Temperature reading,[NUMBER]
[YESNO],Yes / No radio buttons,Example: PPE worn?,[YESNO]
[CHECK],Checkbox (checked = Yes),Example: Fire exits clear,[CHECK]
[PHOTO],Required photo,Example: Photo of completed work,[PHOTO]
[PHOTO?],Optional photo,,
[GPS],Captures current location,,
[SIGN],Signature pad,Example: Sign to confirm,[SIGN]
,,,
Tip: You can mix codes in one cell!,Example → Take photo [PHOTO] and sign [SIGN]`;
  navigator.clipboard.writeText(ref);
  alert("Permanent reference copied! → Paste it starting at cell A20 in your Checklists tab");
}
  
  // ────────────────────── FINAL PACKAGE ──────────────────────
  async function generatePackage() {
    const webAppUrl = document.getElementById('webAppUrl').value.trim();
    if (!webAppUrl.includes('/exec')) { alert("Complete the test first"); return; }
    const isAdv = document.querySelector('input[value="advanced"]').checked;
    const orgName = document.getElementById('orgName').value || "My Company";

    const buildConfig = {
      ORGANISATION_NAME: orgName,
      COMPANY_NAME: orgName,
      ORS_API_KEY: config.orsKey || "",
      GEMINI_API_KEY: config.geminiKey || "",
      FIRST_ALERT_MINUTES: config.firstAlert,
      ESCALATION_MINUTES: config.escalation,
      WEB_APP_URL: webAppUrl,
      GOOGLE_SHEET_URL: webAppUrl,
      CHECKIN_ENABLED: "false",
      CHECKIN_INTERVAL: "60"
    };

    zip = new JSZip();
    let logoDataUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGAoQ0d1gAAAABJRU5ErkJggg==";
    if (logoBlob) {
      logoDataUrl = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(logoBlob);
      });
    }

    let workerHtml = await fetch(`${REPO}/${isAdv ? "worker_app_advanced.txt" : "worker_app_simple.txt"}?t=${Date.now()}`).then(r => r.text());
    for (const key in buildConfig) {
      workerHtml = workerHtml.replace(new RegExp(`%%${key}%%`, 'g'), buildConfig[key]);
    }
    workerHtml = workerHtml.replace(/%%LOGO_URL%%/g, logoDataUrl).replace(/%%FAVICON_URL%%/g, logoDataUrl);

    const manifest = {
      "name": orgName + " On-the-Go",
      "short_name": orgName,
      "description": "Lone worker safety & reporting app",
      "start_url": "/index.html",
      "display": "standalone",
      "background_color": "#111827",
      "theme_color": "#1e40af",
      "icons": [{ "src": logoBlob ? "icon.png" : logoDataUrl, "sizes": "512x512", "type": "image/png", "purpose": "maskable any" }]
    };

    zip.file("index.html", workerHtml);
    zip.file("manifest.json", JSON.stringify(manifest, null, 2));
    if (logoBlob) zip.file("icon.png", logoBlob);
    zip.file("sw.js", await fetch(`${REPO}/sw.js?t=${Date.now()}`).then(r => r.text()));
    zip.file("monitor.html", await fetch(`${REPO}/monitor_app_template.txt?t=${Date.now()}`).then(r => r.text()));
    zip.file("OTG_Backend_Script.gs", finalScriptCode || "// missing");

    const blob = await zip.generateAsync({type: "blob"});
    showStep(6);
    const safeName = orgName.replace(/[^a-zA-Z0-9]/g, '_');
    document.getElementById('downloadBtn').textContent = `Download ${safeName}_AppSuite.zip`;
    document.getElementById('downloadBtn').onclick = () => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${safeName}_AppSuite.zip`;
      a.click();
    };
  }

  // Auto-paste /exec URL when user pastes it anywhere
  document.addEventListener('paste', e => {
    const text = (e.clipboardData || window.clipboardData).getData('text');
    if (text.includes('/exec')) {
      document.getElementById('testUrl').value = text.trim();
      document.getElementById('webAppUrl').value = text.trim();
    }
  });
</script>
