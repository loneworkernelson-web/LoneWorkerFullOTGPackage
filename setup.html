<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>On-the-Go AppSuite - Setup Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    .step { display: none; }
    .step.active { display: block; }
    .step-nav button { @apply transition-all duration-200 px-4 py-2 text-sm font-medium rounded-md; }
    .step-nav button.current { @apply bg-blue-600 text-white font-semibold; }
    .copy-btn { @apply absolute top-3 right-3 bg-gray-600 text-white text-xs px-2 py-1 rounded hover:bg-gray-500 transition; }
    .copy-btn.copied { @apply bg-green-600; }
    .hidden-field { transition: all 0.4s ease; overflow: hidden; }
    .hidden-field.closed { opacity: 0; height: 0; margin: 0; padding: 0; }
    .logo-preview { max-width: 200px; max-height: 200px; border-radius: 0.5rem; }
    .upload-area { border: 2px dashed #4b5563; border-radius: 0.5rem; padding: 2rem; text-align: center; transition: all 0.2s; }
    .upload-area.dragover { border-color: #3b82f6; background: #1e293b; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-blue-400 mb-2">On-the-Go AppSuite</h1>
      <p class="text-xl text-gray-400">Complete Setup Wizard • November 2025</p>
    </div>

    <div class="step-nav flex flex-wrap justify-center gap-3 mb-10 bg-gray-800 p-4 rounded-xl shadow-lg">
      <button type="button" class="current" onclick="showStep(1)">1. Welcome</button>
      <button type="button" onclick="showStep(2)">2. Sheet Setup</button>
      <button type="button" onclick="showStep(3)">3. Configuration</button>
      <button type="button" onclick="showStep(4)">4. Deploy Script</button>
      <button type="button" onclick="showStep(5)">5. Logo & Finalize</button>
      <button type="button" onclick="showStep(6)">6. Done!</button>
    </div>

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12">
      <!-- Steps 1–5 same as before (omitted for brevity – identical to previous version) -->
      <!-- ... [All previous steps unchanged] ... -->

      <!-- Step 6: Success -->
      <div id="step6" class="step text-center py-20 space-y-12">
        <div class="text-9xl">Success!</div>
        <h2 class="text-5xl font-bold text-green-400">Your Complete App Package Is Ready!</h2>
        <p class="text-2xl text-gray-300 max-w-3xl mx-auto">Fully configured • Offline-ready • Includes backup script</p>
        <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 px-20 py-10 rounded-3xl font-bold text-4xl shadow-2xl transform hover:scale-110 transition">
          Download %%COMPANY_NAME%%_AppSuite.zip
        </button>
        <div class="mt-12 text-lg text-gray-400 space-y-2">
          <p>Included files:</p>
          <ul class="text-green-400 font-mono text-sm">
            <li>index.html – Your worker app</li>
            <li>manifest.json – With your logo & name</li>
            <li>sw.js – Offline + instant loading</li>
            <li>OTG_Backend_Script.gs – Full Apps Script backup</li>
            <li>OTG_AppSuite_Documentation.pdf</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const REPO = "https://raw.githubusercontent.com/loneworkernelson-web/LoneWorkerFullOTGPackage/main/Templates";
    let currentStep = 1, zip, logoBlob = null, finalScriptCode = "";

    // ... [All previous functions unchanged until generatePackage()] ...

    async function generatePackage() {
      const isAdv = document.querySelector('input[value="advanced"]').checked;
      const orgName = document.getElementById('orgName').value || "My Company";
      const config = {
        COMPANY_NAME: orgName,
        SECRET_KEY: document.getElementById('secretKey').value || "changeme123",
        FIRST_ALERT_MINUTES: document.getElementById('firstAlert').value,
        ESCALATION_MINUTES: document.getElementById('escalation').value,
        CHECKIN_ENABLED: document.getElementById('checkinEnabled').checked,
        CHECKIN_INTERVAL: document.getElementById('checkinInterval').value,
        ORS_KEY: document.getElementById('orsKey').value,
        GEMINI_KEY: document.getElementById('geminiKey').value,
        WEB_APP_URL: document.getElementById('testUrl').value.trim()
      };

      zip = new JSZip();

      try {
        // Worker App (Advanced or Simple)
        const workerTemplate = await fetch(`${REPO}/${isAdv ? 'worker_app_advanced.txt' : 'worker_app_simple.txt'}`).then(r => r.text());
        let workerHtml = workerTemplate;
        for (const key in config) {
          workerHtml = workerHtml.replace(new RegExp(`%%${key}%%`, 'g'), config[key]);
        }

        // Logo handling
        let logoDataUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGAoQ0d1gAAAABJRU5ErkJggg=="; // 1x1 transparent
        if (logoBlob) {
          logoDataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(logoBlob);
          });
        }
        workerHtml = workerHtml.replace(/%%LOGO_URL%%/g, logoDataUrl).replace(/%%FAVICON_URL%%/g, logoDataUrl);

        // manifest.json – fully dynamic
        const manifest = {
          "name": orgName + " On-the-Go",
          "short_name": orgName,
          "description": "Lone worker safety & reporting app",
          "start_url": "/index.html",
          "display": "standalone",
          "background_color": "#111827",
          "theme_color": "#1e40af",
          "icons": [
            {"src": logoDataUrl, "sizes": "512x512", "type": "image/png", "purpose": "maskable any"}
          ]
        };

        // Add all files
        zip.file("index.html", workerHtml);
        zip.file("manifest.json", JSON.stringify(manifest, null, 2));
        zip.file("sw.js", await fetch(`${REPO}/sw.js`).then(r => r.text()));
        zip.file("OTG_Backend_Script.gs", finalScriptCode || document.getElementById('scriptDisplay').textContent);
        zip.file("OTG_AppSuite_Documentation.pdf", await fetch("Templates/OTG_AppSuite_Documentation.pdf").then(r => r.blob()));

        const finalBlob = await zip.generateAsync({type: "blob"});
        showStep(6);
        document.getElementById('downloadBtn').textContent = `Download ${orgName}_AppSuite.zip`;
        document.getElementById('downloadBtn').onclick = () => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(finalBlob);
          a.download = `${orgName.replace(/[^a-zA-Z0-9]/g,'_')}_AppSuite.zip`;
          a.click();
        };
      } catch (err) {
        console.error(err);
        alert("Package generation failed: " + err.message);
      }
    }

    // Save script code when generated
    async function generateScriptAndProceed() {
      // ... existing code ...
      const script = template
        .replace(/%%SECRET_KEY%%/g, config.SECRET_KEY)
        .replace(/%%VISITS_SHEET_NAME%%/g, config.VISITS_SHEET_NAME)
        .replace(/%%CHECKLISTS_SHEET_NAME%%/g, config.CHECKLISTS_SHEET_NAME)
        .replace(/%%ESCALATION_MINUTES%%/g, config.ESCALATION_MINUTES)
        .replace(/%%FIRST_ALERT_MINUTES%%/g, config.FIRST_ALERT_MINUTES);

      finalScriptCode = script;  // ← This saves it for backup
      document.getElementById('scriptDisplay').textContent = script;
      showStep(4);
    }

    // ... rest of script unchanged ...
  </script>
</body>
</html>
