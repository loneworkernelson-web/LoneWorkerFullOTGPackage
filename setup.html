<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>On-the-Go AppSuite - Setup Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    .step { display: none; }
    .step.active { display: block; }
    .step-nav button { @apply transition-all duration-200 px-4 py-2 text-sm font-medium rounded-md; }
    .step-nav button.current { @apply bg-blue-600 text-white font-semibold; }
    .copy-btn { @apply absolute top-3 right-3 bg-gray-600 text-white text-xs px-2 py-1 rounded hover:bg-gray-500 transition; }
    .copy-btn.copied { @apply bg-green-600; }
    .hidden-field { transition: all 0.4s ease; overflow: hidden; }
    .hidden-field.closed { opacity: 0; height: 0; margin: 0; padding: 0; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-blue-400 mb-2">On-the-Go AppSuite</h1>
      <p class="text-xl text-gray-400">Full Production Setup Wizard • November 2025</p>
    </div>

    <!-- Updated Step Navigation -->
    <div class="step-nav flex flex-wrap justify-center gap-3 mb-10 bg-gray-800 p-4 rounded-xl shadow-lg">
      <button type="button" class="current" onclick="showStep(1)">1. Welcome</button>
      <button type="button" onclick="showStep(2)">2. Sheet Setup</button>
      <button type="button" onclick="showStep(3)">3. Configuration</button>
      <button type="button" onclick="showStep(4)">4. Deploy Script</button>
      <button type="button" onclick="showStep(5)">5. Paste URL</button>
      <button type="button" onclick="showStep(6)">6. Done!</button>
    </div>

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12">

      <!-- Step 1: Welcome (unchanged) -->
      <div id="step1" class="step active space-y-10">
        <h2 class="text-3xl font-bold text-center text-blue-300">Welcome! Choose Your App Type</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <label class="block cursor-pointer">
            <input type="radio" name="appMode" value="simple" checked onchange="toggleAdvanced()" class="hidden peer">
            <div class="bg-gray-900 border-2 border-gray-700 rounded-xl p-8 text-center hover:border-blue-500 transition peer-checked:border-blue-500 peer-checked:bg-blue-900/20">
              <div class="text-6xl mb-4">Shield</div>
              <h3 class="text-2xl font-bold">Simple App</h3>
              <p class="text-gray-400 mt-3">Safety-only • Timer • SOS • Duress PIN</p>
              <p class="text-green-400 font-bold mt-4">Most Popular</p>
            </div>
          </label>
          <label class="block cursor-pointer">
            <input type="radio" name="appMode" value="advanced" onchange="toggleAdvanced()" class="hidden peer">
            <div class="bg-gray-900 border-2 border-gray-700 rounded-xl p-8 text-center hover:border-blue-500 transition peer-checked:border-blue-500 peer-checked:bg-blue-900/20">
              <div class="text-6xl mb-4">Tools</div>
              <h3 class="text-2xl font-bold">Advanced App</h3>
              <p class="text-gray-400 mt-3">Full reporting • Photos • Gemini AI • Distance tracking</p>
              <p class="text-yellow-400 font-bold mt-4">Reporting Features</p>
            </div>
          </label>
        </div>
        <div class="text-center space-y-6">
          <a href="Templates/OTG_AppSuite_Documentation.pdf" target="_blank" class="inline-block bg-indigo-600 hover:bg-indigo-700 px-10 py-4 rounded-xl font-bold text-xl">
            Download Full Documentation (PDF)
          </a>
          <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 px-12 py-5 rounded-xl font-bold text-2xl ml-6">
            Start Setup
          </button>
        </div>
      </div>

           <!-- Step 2: Google Sheet Setup – NOW SUPER FRIENDLY -->
      <div id="step2" class="step space-y-10">
        <h2 class="text-3xl font-bold text-center text-blue-300">Step 2: Set Up Your Google Sheet (Don't worry — it's easy!)</h2>

        <div class="bg-yellow-900/30 border border-yellow-600 rounded-xl p-8 max-w-4xl mx-auto text-center">
          <p class="text-xl text-yellow-300 font-semibold">This is the only slightly technical part — we’ll do it together</p>
          <p class="text-lg text-gray-300 mt-3">You’ll create a normal Google Sheet (like Excel) — just follow the big buttons below</p>
        </div>

        <div class="space-y-12 max-w-5xl mx-auto">

          <!-- Part 1: Create the Sheet -->
          <div class="bg-gray-900 rounded-xl p-8 border border-gray-700">
            <h3 class="text-2xl font-bold text-blue-400 mb-6">1. Create Your Google Sheet</h3>
            <p class="text-lg text-gray-300 mb-6">Click the big button below — it opens a brand new blank Google Sheet for you:</p>
            <div class="text-center">
              <a href="https://sheets.new" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 px-12 py-6 rounded-xl font-bold text-2xl shadow-lg transform hover:scale-105 transition">
                Click Here to Open Your New Sheet
              </a>
            </div>
            <p class="text-gray-400 mt-6 text-center">A new tab will open — leave it open and come back here</p>
          </div>

          <!-- Part 2: Visits Tab Headers -->
          <div class="bg-gray-900 rounded-xl p-8 border border-gray-700">
            <h3 class="text-2xl font-bold text-blue-400 mb-6">2. Set Up the "Visits" Tab (Everyone needs this)</h3>
            <ol class="text-lg text-gray-300 space-y-5 list-decimal list-inside max-w-3xl mx-auto">
              <li>At the bottom of your sheet, you’ll see a tab called <strong>Sheet1</strong></li>
              <li>Double-click that tab name → type exactly: <strong class="text-yellow-300">Visits</strong> → press Enter</li>
              <li>Click on cell <strong>A1</strong> (top-left cell) so it’s highlighted</li>
              <li>Click the big <strong>Copy</strong> button below</li>
              <li>Go back to your Google Sheet and press <strong>Ctrl+V</strong> (or Cmd+V on Mac) to paste</li>
            </ol>

            <div class="relative bg-gray-800 p-8 rounded-xl border border-gray-600 mt-8 font-mono text-sm">
              <button type="button" onclick="copyHeaders()" class="copy-btn text-lg px-4 py-2">Copy Visits Headers</button>
              <pre id="headers" class="text-gray-400 overflow-x-auto mt-4">Date,Worker Name,Worker Phone Number,Emergency Contact Name,Emergency Contact Number,Emergency Contact Email,Escalation Contact Name,Escalation Contact Number,Escalation Contact Email,Location Name,Location Address,Arrival Time,Anticipated Departure Time,Actual Departure Time,Alarm Status,Notes,Last Known GPS,GPS Timestamp,Battery Level</pre>
            </div>
            <p class="text-center text-green-400 font-bold mt-6 text-xl">You’ve done the main part!</p>
          </div>

          <!-- Part 3: Checklists Tab (Advanced Only) -->
          <div id="checklistsSection" class="bg-gray-900 rounded-xl p-8 border border-gray-700 hidden">
            <h3 class="text-2xl font-bold text-yellow-300 mb-6">Bonus: Set Up the "Checklists" Tab (Only if you chose Advanced App)</h3>
            <ol class="text-lg text-gray-300 space-y-5 list-decimal list-inside max-w-3xl mx-auto">
              <li>At the bottom-left, click the <strong>+</strong> button to add a new tab</li>
              <li>Double-click the new tab name → type exactly: <strong class="text-yellow-300">Checklists</strong> → press Enter</li>
              <li>Click cell <strong>A1</strong> in this new tab</li>
              <li>Click the <strong>Copy Checklists Headers</strong> button below</li>
              <li>Paste into your sheet with <strong>Ctrl+V</strong></li>
            </ol>

            <div class="relative bg-gray-800 p-8 rounded-xl border border-gray-600 mt-8 font-mono text-sm">
              <button type="button" onclick="copyChecklistsHeaders()" class="copy-btn text-lg px-4 py-2 bg-purple-600 hover:bg-purple-700">Copy Checklists Headers</button>
              <pre id="checklistsHeaders" class="text-gray-400 overflow-x-auto mt-4">Template Name,Question 1,Question 2,Question 3,Question 4,Question 5,Question 6,Question 7,Question 8,Question 9,Question 10,Question 11,Question 12,Question 13,Question 14,Question 15,Question 16,Question 17,Question 18,Question 19,Question 20,Question 21,Question 22,Question 23,Question 24,Question 25,Question 26,Question 27,Question 28,Question 29,Question 30,Question 31,Question 32,Question 33,Question 34,Question 35,Question 36,Question 37,Question 38,Question 39,Question 40</pre>
            </div>

            <div class="bg-blue-900/50 border border-blue-600 rounded-xl p-6 mt-8 text-center">
              <p class="text-xl text-blue-300 font-semibold">Tip: You can delete any extra "Question" columns you don’t need later</p>
              <p class="text-gray-400 mt-2">Or just leave them — they won’t hurt anything</p>
            </div>
          </div>

          <!-- Final Button -->
          <div class="text-center pt-8">
            <button onclick="nextStep()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-20 py-8 rounded-xl font-bold text-3xl shadow-2xl transform hover:scale-105 transition">
              I’ve Done This — Take Me to the Next Step
            </button>
          </div>

        </div>
      </div>

      <!-- Step 3: Configuration (unchanged) -->
      <div id="step3" class="step space-y-10">
        <h2 class="text-3xl font-bold text-center text-blue-300">Step 3: Your Settings</h2>
        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          <div><label class="block text-lg font-medium mb-2">Organisation Name</label><input type="text" id="orgName" value="My Company" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">Secret Key (Monitor Dashboard)</label><input type="password" id="secretKey" placeholder="Strong password" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">First Alert After (minutes)</label><input type="number" id="firstAlert" value="15" min="1" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div><label class="block text-lg font-medium mb-2">Escalation After (minutes)</label><input type="number" id="escalation" value="5" min="1" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div id="orsField" class="hidden-field closed"><label class="block text-lg font-medium mb-2 text-yellow-300">OpenRouteService API Key (Distance)</label><input type="text" id="orsKey" placeholder="Optional • openrouteservice.org" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div id="geminiField" class="hidden-field closed"><label class="block text-lg font-medium mb-2 text-yellow-300">Gemini API Key (AI Spellcheck)</label><input type="text" id="geminiKey" placeholder="Optional • aistudio.google.com" class="w-full px-5 py-4 bg-gray-700 rounded-lg text-lg"></div>
          <div class="md:col-span-2">
            <label class="flex items-center space-x-4 text-lg">
              <input type="checkbox" id="checkinEnabled" class="h-6 w-6 text-blue-600">
              <span>Enable check-ins every</span>
              <input type="number" id="checkinInterval" value="30" min="5" class="w-24 px-4 py-3 bg-gray-700 rounded-lg mx-2">
              <span>minutes</span>
            </label>
          </div>
        </div>
        <div class="text-center">
          <button onclick="generateScriptAndProceed()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-16 py-6 rounded-xl font-bold text-2xl shadow-2xl transform hover:scale-105 transition">
            Generate Apps Script Code →
          </button>
        </div>
      </div>

           <!-- Step 4: Deploy Apps Script – EXTREMELY DETAILED FOR BEGINNERS -->
      <div id="step4" class="step space-y-12">
        <h2 class="text-3xl font-bold text-center text-blue-300">Step 4: Connect Everything to Your Google Sheet</h2>

        <div class="bg-yellow-900/30 border-2 border-yellow-600 rounded-2xl p-10 max-w-5xl mx-auto text-center">
          <p class="text-2xl text-yellow-300 font-bold">Don’t panic — this looks scary but we’ll do it together!</p>
          <p class="text-xl text-gray-300 mt-4">You’re just going to copy-paste one block of code and click a few buttons.</p>
        </div>

        <!-- 4A: Paste the code -->
        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700 space-y-8">
          <h3 class="text-2xl font-bold text-blue-400">1. Open Google Apps Script & Paste the Code</h3>
          <ol class="text-lg text-gray-300 space-y-6 list-decimal list-inside max-w-4xl mx-auto">
            <li>Click this huge button → a new tab will open:</li>
            <div class="text-center my-8">
              <a href="https://script.new" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 px-16 py-8 rounded-2xl font-bold text-3xl shadow-2xl transform hover:scale-105 transition">
                Open script.new (Click Me!)
              </a>
            </div>
            <li>In the new tab, delete everything that’s already there (it’s just a sample function)</li>
            <li>Click the big <strong>Copy All Code</strong> button below</li>
            <li>Paste into the blank script editor using <strong>Ctrl+V</strong> (or Cmd+V on Mac)</li>
            <li>At the top-left, rename the project from “Untitled project” to something like <strong>OTG AppSuite Backend</strong></li>
            <li>Click the blue <strong>Save</strong> button (or press Ctrl+S)</li>
          </ol>

          <div class="relative bg-gray-800 p-10 rounded-xl border border-gray-600 mt-10 font-mono text-sm">
            <button type="button" onclick="copyScript()" class="copy-btn text-lg px-6 py-3">Copy All Code</button>
            <pre id="scriptDisplay" class="text-left text-gray-400 overflow-x-auto h-96 mt-6 whitespace-pre-wrap"></pre>
          </div>
        </div>

        <!-- 4B: Deploy as Web App -->
        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700 space-y-8">
          <h3 class="text-2xl font-bold text-blue-400">2. Deploy as Web App (One-click)</h3>
          <ol class="text-lg text-gray-300 space-y-5 list-decimal list-inside max-w-4xl mx-auto">
            <li>At the top-right, click the blue button that says <strong>Deploy</strong> → <strong>New deployment</strong></li>
            <li>Click <strong>Select type</strong> → choose <strong>Web app</strong></li>
            <li>Leave everything as default except:</li>
            <ul class="list-disc list-inside ml-8 text-gray-400 space-y-2">
              <li><strong>Who has access:</strong> choose <strong>Anyone</strong> (yes, really — it’s safe because of your secret key)</li>
            </ul>
            <li>Click the big blue <strong>Deploy</strong> button</li>
            <li>If Google asks for permissions, click <strong>Allow</strong> (it needs to read your sheet)</li>
            <li>A box will pop up with a long URL ending in <strong>/exec</strong> → <strong>Copy that entire URL</strong></li>
          </ol>
        </div>

        <!-- 4C: Set up the automatic trigger -->
        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700 space-y-8">
          <h3 class="text-2xl font-bold text-blue-400">3. Set Up the 1-Minute Automatic Check (Important!)</h3>
          <p class="text-xl text-gray-300 max-w-4xl mx-auto">This makes overdue alerts work automatically.</p>
          <ol class="text-lg text-gray-300 space-y-5 list-decimal list-inside max-w-4xl mx-auto">
            <li>In the same Apps Script window, click the clock icon on the left sidebar (Triggers)</li>
            <li>Click <strong>+ Add Trigger</strong> (bottom right)</li>
            <li>Choose these exact settings:</li>
            <ul class="list-none ml-8 text-gray-400 space-y-3 text-lg">
              <li><strong>Function to run:</strong> checkOverdueVisits</li>
              <li><strong>Deployment:</strong> Head</li>
              <li><strong>Event source:</strong> Time-driven</li>
              <li><strong>Type:</strong> Minutes timer</li>
              <li><strong>Every minutes:</strong> 1</li>
            </ul>
            <li>Click <strong>Save</strong></li>
          </ol>
          <p class="text-center text-green-400 font-bold text-2xl mt-8">This trigger is what makes your alerts work!</p>
        </div>

        <!-- 4D: Test the connection -->
        <div class="bg-gray-900 rounded-2xl p-10 border border-gray-700 space-y-8">
          <h3 class="text-2xl font-bold text-green-400">4. Test That Everything Is Connected</h3>
          <p class="text-xl text-gray-300 max-w-4xl mx-auto">We’ll do a live test right now — takes 10 seconds</p>
          <div class="text-center space-y-6">
            <p class="text-lg">Paste your <strong>/exec</strong> URL here:</p>
            <input type="url" id="testUrl" placeholder="https://script.google.com/macros/s/.../exec" class="w-full max-w-2xl px-6 py-5 bg-gray-700 rounded-xl text-lg text-center">
            <p class="text-lg mt-6">Your secret key (from Step 3):</p>
            <input type="text" id="testKey" value="" placeholder="Your secret key appears here automatically" class="w-full max-w-2xl px-6 py-5 bg-gray-700 rounded-xl text-lg text-center" readonly>
            <button onclick="testConnection()" class="mt-8 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 px-16 py-8 rounded-xl font-bold text-3xl shadow-2xl transform hover:scale-105 transition">
              Test Connection Now
            </button>
            <div id="testResult" class="mt-8 text-2xl font-bold"></div>
          </div>
        </div>

        <!-- Final button (only appears after successful test) -->
        <div class="text-center pt-10">
          <button id="proceedAfterTest" onclick="nextStep()" disabled class="bg-gradient-to-r from-green-600 to-emerald-600 opacity-50 px-20 py-10 rounded-2xl font-bold text-4xl cursor-not-allowed">
            All Working! → Next Step
          </button>
        </div>
      </div>

      <!-- Step 5: Paste Web App URL -->
      <div id="step5" class="step space-y-8 text-center">
        <h2 class="text-3xl font-bold text-blue-300">Step 5: Paste Your Web App URL</h2>
        <p class="text-xl text-gray-300">Copy the URL that ends in <code class="bg-gray-700 px-3 py-1 rounded">/exec</code></p>
        <input type="url" id="webAppUrl" placeholder="https://script.google.com/macros/s/AKfyc.../exec" class="w-full max-w-3xl mx-auto px-6 py-5 bg-gray-700 rounded-xl text-lg text-center">
        <button onclick="finalizeWithWebAppUrl()" class="mt-8 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-20 py-8 rounded-xl font-bold text-3xl shadow-2xl transform hover:scale-105 transition">
          Generate Final Apps →
        </button>
      </div>

      <!-- Step 6: Success -->
      <div id="step6" class="step text-center py-20 space-y-12">
        <div class="text-9xl">Success</div>
        <h2 class="text-5xl font-bold text-green-400">Your Complete App Package Is Ready!</h2>
        <p class="text-2xl text-gray-300 max-w-3xl mx-auto">Fully configured and linked to your Google Sheet</p>
        <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 px-20 py-10 rounded-3xl font-bold text-4xl shadow-2xl transform hover:scale-110 transition">
          Download OTG_AppSuite.zip
        </button>
      </div>

    </div>
  </div>

  <script>
    const REPO_RAW = "https://raw.githubusercontent.com/loneworkernelson-web/LoneWorkerFullOTGPackage/main/Templates";
    let config = {}, gasCode = "", finalZip;

    function toggleAdvanced() {
      const adv = document.querySelector('input[value="advanced"]').checked;
      document.getElementById('checklistsNote').classList.toggle('hidden', !adv);
      document.querySelectorAll('.hidden-field').forEach(el => el.classList.toggle('closed', !adv));
    }

    function showStep(n) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + n).classList.add('active');
      document.querySelectorAll('.step-nav button').forEach((b, i) => b.classList.toggle('current', i + 1 === n));
    }

    function nextStep() {
      const current = +document.querySelector('.step.active').id.replace('step', '');
      showStep(current + 1);
    }

    function copyHeaders() {
      navigator.clipboard.writeText(document.getElementById('headers').textContent);
      const btn = document.querySelector('#step2 .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
    }

    function copyChecklistsHeaders() {
      const text = document.getElementById('checklistsHeaders').textContent;
      navigator.clipboard.writeText(text);
      const btn = document.querySelector('#checklistsSection .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy Checklists Headers'; btn.classList.remove('copied'); }, 2000);
    }

    // Auto-show Checklists section if Advanced mode is selected
    function toggleAdvanced() {
      const adv = document.querySelector('input[value="advanced"]').checked;
      document.getElementById('checklistsNote')?.classList.toggle('hidden', !adv);
      document.getElementById('checklistsSection')?.classList.toggle('hidden', !adv);
      document.querySelectorAll('.hidden-field').forEach(el => el.classList.toggle('closed', !adv));
    }
    function copyScript() {
      navigator.clipboard.writeText(gasCode);
      const btn = document.querySelector('#step4 .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
    }

    async function generateScriptAndProceed() {
      config = {
        orgName: document.getElementById('orgName').value || "My Company",
        secretKey: document.getElementById('secretKey').value || "changeme123",
        firstAlert: document.getElementById('firstAlert').value,
        escalation: document.getElementById('escalation').value,
        orsKey: document.getElementById('orsKey').value,
        geminiKey: document.getElementById('geminiKey').value,
        checkinEnabled: document.getElementById('checkinEnabled').checked,
        checkinInterval: document.getElementById('checkinInterval').value,
        advanced: document.querySelector('input[value="advanced"]').checked
      };

      const template = await fetch(`${REPO_RAW}/apps_script_advanced.txt?t=${Date.now()}`).then(r => r.text());
      gasCode = template.replace(/%%SECRET_KEY%%/g, config.secretKey);
      document.getElementById('scriptDisplay').textContent = gasCode;
      showStep(4);
    }

    async function finalizeWithWebAppUrl() {
      const webAppUrl = document.getElementById('webAppUrl').value.trim();
      if (!webAppUrl.includes('/exec')) {
        alert("Please paste the correct Web App URL ending in /exec");
        return;
      }

      const zip = new JSZip();

      const workerFile = config.advanced ? "worker_app_advanced.txt" : "worker_app_simple.txt";
      let workerHtml = await fetch(`${REPO_RAW}/${workerFile}?t=${Date.now()}`).then(r => r.text());

      // Inject all settings
      workerHtml = workerHtml
        .replace(/%%ORGANISATION_NAME%%/g, config.orgName)
        .replace(/%%ORS_API_KEY%%/g, config.orsKey)
        .replace(/%%GEMINI_API_KEY%%/g, config.geminiKey)
        .replace(/%%FIRST_ALERT_MINUTES%%/g, config.firstAlert)
        .replace(/%%ESCALATION_MINUTES%%/g, config.escalation)
        .replace(/%%CHECKIN_ENABLED%%/g, config.checkinEnabled ? "true" : "false")
        .replace(/%%CHECKIN_INTERVAL%%/g, config.checkinInterval)
        .replace(/%%WEB_APP_URL%%/g, webAppUrl);  // CRITICAL INJECTION

      zip.file("index.html", workerHtml);
      zip.file("monitor.html", await fetch(`${REPO_RAW}/monitor_app_template.txt?t=${Date.now()}`).then(r => r.text()));
      zip.file("manifest.json", await fetch(`${REPO_RAW}/manifest.json?t=${Date.now()}`).then(r => r.text()));
      zip.file("OTG_AppSuite_Documentation.pdf", await fetch("Templates/OTG_AppSuite_Documentation.pdf").then(r => r.blob()));

      finalZip = await zip.generateAsync({type: "blob"});
      showStep(6);

      document.getElementById('downloadBtn').onclick = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(finalZip);
        a.download = "OTG_AppSuite_Complete.zip";
        a.click();
      };
    }

        // Auto-fill secret key in test field
    document.getElementById('testKey').value = document.getElementById('secretKey').value || "changeme123";

    function copyScript() {
      navigator.clipboard.writeText(gasCode);
      const btn = document.querySelector('#step4 .copy-btn');
      btn.textContent = 'Copied!'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy All Code'; btn.classList.remove('copied'); }, 2000);
    }

    async function testConnection() {
      const url = document.getElementById('testUrl').value.trim();
      const key = document.getElementById('testKey').value;
      const resultDiv = document.getElementById('testResult');
      const proceedBtn = document.getElementById('proceedAfterTest');

      if (!url || !url.includes('/exec')) {
        resultDiv.innerHTML = '<span class="text-red-400">Please paste your full /exec URL</span>';
        return;
      }

      resultDiv.textContent = "Testing...";
      try {
        const response = await fetch(`${url}?test=1&key=${encodeURIComponent(key)}`);
        const text = await response.text();
        if (text.includes("OTG_SUCCESS")) {
          resultDiv.innerHTML = '<span class="text-green-400 text-3xl">Perfect! Everything is connected!</span>';
          proceedBtn.disabled = false;
          proceedBtn.className = 'bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-20 py-10 rounded-2xl font-bold text-4xl shadow-2xl transform hover:scale-105 transition cursor-pointer';
          document.getElementById('webAppUrl').value = url; // auto-fill next step
        } else {
          resultDiv.innerHTML = '<span class="text-red-400">Failed — check your secret key and URL</span>';
        }
      } catch (e) {
        resultDiv.innerHTML = '<span class="text-red-400">Connection failed — double-check the URL</span>';
      }
    }
    toggleAdvanced();
  </script>
</body>
</html>
