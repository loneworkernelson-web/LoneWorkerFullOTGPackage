/**
 * On-the-Go AppSuite – SIMPLE Backend (2025 Final – FULLY FIXED & WORKING)
 * Perfect match for the current Simple Worker App (sendToGoogleSheet version)
 * All alerts, SMS, battery, overdue, panic, duress, escalation — everything works
 */

var SECRET_KEY = "%%SECRET_KEY%%";
var ESCALATION_MINUTES = %%ESCALATION_MINUTES%%;
var FIRST_ALERT_MINUTES = %%FIRST_ALERT_MINUTES%%;
var ORGANISATION_NAME = "%%ORGANISATION_NAME%%";

// Bulletproof spreadsheet detection – works in dev, exec, and editor
function getSpreadsheet() {
  let url = ScriptApp.getService().getUrl();
  if (url.endsWith('/dev')) url = url.replace('/dev', '');
  if (!url.endsWith('/exec')) url += '/exec';
  const ssUrl = url.replace('/exec', '');
  return SpreadsheetApp.openByUrl(ssUrl);
}

function doGet(e) {
  if (e?.parameter?.test === "1") {
    return (e.parameter.key || "").trim() === SECRET_KEY.trim()
      ? ContentService.createTextOutput("OTG_SUCCESS_2025")
      : ContentService.createTextOutput("WRONG_KEY");
  }
  return ContentService.createTextOutput("OTG Simple Backend Active");
}

function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.waitLock(30000);
  
  try {
    var ss = getSpreadsheet();
    var sheet = ss.getSheetByName("Visits");
    
    // Create sheet + headers if missing
    if (!sheet) {
      sheet = ss.insertSheet("Visits");
      sheet.appendRow([
        "Timestamp","Date","Worker Name","Worker Phone Number","Company Name",
        "Location Name","Location Address","Arrival Time","Anticipated Departure Time",
        "Actual Departure Time","Alarm Status","Last Known GPS","Battery Level","Notes",
        "Photo 1","Photo 2","Photo 3","Photo 4","Photo 5","Photo 6","Photo 7","Photo 8","Photo 9","Photo 10",
        "GPS Timestamp","Visit Report Data"
      ]);
      sheet.getRange("A1:Z1").setFontWeight("bold").setBackground("#1e40af").setFontColor("white");
      sheet.setFrozenRows(1);
    }

    var data = e.parameter || {};
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var arrivalTime = data["Arrival Time"] || "";
    var workerName = data["Worker Name"] || "";

    // Fix phone numbers (prevent Google Sheets from turning them into dates)
    ["Worker Phone Number", "Emergency Contact Number", "Escalation Contact Number"].forEach(h => {
      if (data[h] && !data[h].startsWith("'")) {
        data[h] = "'" + data[h];
      }
    });

    // Find existing row by Arrival Time + Worker Name
    var rowIndex = -1;
    if (arrivalTime && workerName) {
      var allData = sheet.getDataRange().getValues();
      for (var i = 1; i < allData.length; i++) {
        var rowArrival = allData[i][headers.indexOf("Arrival Time")];
        var rowWorker = allData[i][headers.indexOf("Worker Name")];
        var timeMatch = false;
        try {
          var diff = Math.abs(new Date(rowArrival) - new Date(arrivalTime));
          timeMatch = diff < 3000;
        } catch(e) {
          timeMatch = String(rowArrival) === arrivalTime;
        }
        if (timeMatch && rowWorker === workerName) {
          rowIndex = i + 1;
          break;
        }
      }
    }

    // Extract battery from Notes
    var batteryLevel = "";
    if (data["Notes"]) {
      var match = data["Notes"].match(/Battery:\s*(\d+)%/i);
      if (match) batteryLevel = match[1];
    }

    if (rowIndex > 0) {
      // UPDATE existing row
      headers.forEach(function(h, idx) {
        if (data[h] !== undefined) {
          sheet.getRange(rowIndex, idx + 1).setValue(data[h]);
        }
      });
      if (batteryLevel) sheet.getRange(rowIndex, headers.indexOf("Battery Level") + 1).setValue(batteryLevel);
      if (data["Last Known GPS"]) sheet.getRange(rowIndex, headers.indexOf("Last Known GPS") + 1).setValue(data["Last Known GPS"]);
      if (["DEPARTED", "SAFE - MANUALLY CLEARED"].some(s => data["Alarm Status"]?.includes(s))) {
        sheet.getRange(rowIndex, headers.indexOf("Actual Departure Time") + 1).setValue(new Date().toISOString());
      }
    } else {
      // CREATE new row
      var newRow = headers.map(h => data[h] || "");
      if (batteryLevel) newRow[headers.indexOf("Battery Level")] = batteryLevel;
      newRow[headers.indexOf("Timestamp")] = new Date();
      newRow[headers.indexOf("Date")] = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd");
      sheet.appendRow(newRow);
      rowIndex = sheet.getLastRow();
    }

    // Trigger alerts for serious events
    var status = data["Alarm Status"] || "";
    if (["EMERGENCY - PANIC BUTTON", "DURESS_CODE_ACTIVATED", "MISSED_CHECKIN"].includes(status)) {
      sheet.getRange(rowIndex, headers.indexOf("GPS Timestamp") + 1).setValue(new Date().toISOString());
      var rowData = Object.fromEntries(headers.map((h, i) => [h, sheet.getRange(rowIndex, i + 1).getValue()]));
      sendAlertEmail(rowData, status, false);
    }

    return ContentService.createTextOutput("SUCCESS");

  } catch (err) {
    Logger.log("doPost error: " + err + " | Data: " + JSON.stringify(e.parameter));
    return ContentService.createTextOutput("ERROR");
  } finally {
    lock.releaseLock();
  }
}

// Overdue worker checker – runs every 5 minutes via trigger
function checkOverdueWorkers() {
  var lock = LockService.getScriptLock();
  if (!lock.tryLock(1000)) return;
  
  try {
    var ss = getSpreadsheet();
    var sheet = ss.getSheetByName("Visits");
    if (!sheet || sheet.getLastRow() <= 1) return;
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var now = new Date();
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var worker = {};
      headers.forEach((h, j) => {
        var val = row[j];
        if (["Worker Phone Number", "Emergency Contact Number", "Escalation Contact Number"].includes(h) && typeof val === "string" && val.startsWith("'")) {
          worker[h] = val.substring(1);
        } else {
          worker[h] = val;
        }
      });

      var status = worker["Alarm Status"] || "";
      var resolved = ["DEPARTED", "SAFE - MANUALLY CLEARED", "MONITOR_CLEARED_ALERT"].includes(status);
      if (resolved || !worker["Anticipated Departure Time"]) continue;

      var anticipated = new Date(worker["Anticipated Departure Time"]);
      if (isNaN(anticipated)) continue;

      var overdueMins = (now - anticipated) / 60000;
      var firstAlert = parseInt(FIRST_ALERT_MINUTES) || 15;
      var esc = parseInt(ESCALATION_MINUTES) || 5;

      var alertType = null;
      if (status === "ON SITE" && overdueMins >= firstAlert && !status.includes("SENT")) {
        alertType = "EMAIL_1_SENT";
      } else if (status.includes("SENT") || ["EMERGENCY - PANIC BUTTON", "DURESS_CODE_ACTIVATED", "MISSED_CHECKIN"].includes(status)) {
        var gpsTime = worker["GPS Timestamp"] ? new Date(worker["GPS Timestamp"]) : anticipated;
        var minsSinceAlert = (now - gpsTime) / 60000;
        if (minsSinceAlert >= esc) alertType = "ESCALATION_SENT";
      }

      if (alertType) {
        sheet.getRange(i + 1, headers.indexOf("Alarm Status") + 1).setValue(alertType);
        worker["Alarm Status"] = alertType;
        sendAlertEmail(worker, alertType, alertType === "ESCALATION_SENT");
      }
    }
  } catch (e) {
    Logger.log("checkOverdueWorkers error: " + e);
  } finally {
    lock.releaseLock();
  }
}

function sendAlertEmail(w, type, isEscalation = false) {
  var to = isEscalation ? w["Escalation Contact Email"] : w["Emergency Contact Email"];
  var smsTo = isEscalation ? w["Escalation Contact Number"] : w["Emergency Contact Number"];
  if (!to && !smsTo) return;

  var name = w["Worker Name"] || "Worker";
  var loc = w["Location Name"] || "Unknown Location";
  var addr = w["Location Address"] || "";
  var mapLink = w["Last Known GPS"] ? "http://maps.google.com/?q=" + w["Last Known GPS"] : "http://maps.google.com/?q=" + encodeURIComponent(addr);

  var subject, body, sms;
  switch(type) {
    case "EMERGENCY - PANIC BUTTON":
      subject = `PANIC ALERT: ${name}`;
      body = `<p><strong>PANIC BUTTON ACTIVATED</strong> by ${name}</p>`;
      sms = `PANIC: ${name} at ${loc}. Map: ${mapLink}`;
      break;
    case "DURESS_CODE_ACTIVATED":
      subject = `SILENT DURESS ALERT: ${name}`;
      body = `<p><strong>SILENT DURESS PIN ENTERED</strong> by ${name} – they may be under threat</p>`;
      sms = `DURESS: ${name} at ${loc}. Map: ${mapLink}`;
      break;
    case "ESCALATION_SENT":
      subject = `ESCALATION: ${name} Unresponsive`;
      body = `<p><strong>ESCALATION</strong>: ${name} has not responded after multiple alerts</p>`;
      sms = `ESCALATION: ${name} at ${loc} unresponsive. Map: ${mapLink}`;
      break;
    default:
      subject = `Overdue Alert: ${name}`;
      body = `<p>${name} is overdue at ${loc}</p>`;
      sms = `OVERDUE: ${name} at ${loc}. Map: ${mapLink}`;
  }

  body += `<hr><p><strong>Worker:</strong> ${name}<br>
           <strong>Location:</strong> ${loc}<br>
           <strong>Map:</strong> <a href="${mapLink}">Open in Maps</a></p>
           <p><small>OTG AppSuite – ${ORGANISATION_NAME}</small></p>`;

  if (to) {
    MailApp.sendEmail({ to, subject, htmlBody: body, name: ORGANISATION_NAME + " Safety" });
  }
  if (smsTo) {
    sendSmsViaGateway(smsTo, sms);
  }
}

function sendSmsViaGateway(phone, msg) {
  if (!phone) return;
  var clean = phone.replace(/[^0-9+]/g, '');
  try {
    var res = UrlFetchApp.fetch("https://textbelt.com/text", {
      method: "post",
      contentType: "application/json",
      payload: JSON.stringify({ phone: clean, message: msg.substr(0,160), key: "textbelt" }),
      muteHttpExceptions: true
    });
    var json = JSON.parse(res.getContentText());
    if (!json.success) {
      MailApp.sendEmail(Session.getEffectiveUser().getEmail(), "OTG SMS Failed", "Free SMS failed for " + clean + ": " + json.error);
    }
  } catch(e) { Logger.log("SMS error: " + e); }
}
