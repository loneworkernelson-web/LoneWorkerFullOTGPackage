// ##### --------------------------------------------------- #####
// ##### On-the-Go AppSuite - SIMPLE Backend Script (Safety Only) #####
// ##### v2.1 (with SMS Escalation Fix)
// ##### --------------------------------------------------- #####

// --- CONFIGURATION ---
var SECRET_KEY = "%%SECRET_KEY%%"; // For Monitor App
var SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();
var VISITS_SHEET_NAME = "Visits";
var ESCALATION_MINUTES = %%ESCALATION_MINUTES%%; // Time in minutes to wait before escalating

// --- WEB APP ENDPOINTS ---

/**
 * Handles GET requests from the Monitor App.
 */
function doGet(e) {
  // 1. Monitor App Request (JSONP)
  if (e.parameter.callback) {
    var token = e.parameter.token;
    if (token !== SECRET_KEY) {
      return ContentService
        .createTextOutput(JSON.stringify({ status: "error", message: "Access Denied" }))
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(VISITS_SHEET_NAME);
    var data = sheet.getDataRange().getValues();
    var headers = data.shift();
    var json = data.map(function(row) {
      var obj = {};
      headers.forEach(function(header, i) {
        if (row[i] instanceof Date) {
          obj[header] = row[i].toISOString(); 
        } else {
          obj[header] = row[i];
        }
      });
      return obj;
    });

    var callback = e.parameter.callback;
    var jsonpResponse = callback + '(' + JSON.stringify(json) + ')';
    return ContentService
      .createTextOutput(jsonpResponse)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  // Default invalid request
  return ContentService
    .createTextOutput(JSON.stringify({ status: "error", message: "Invalid request" }))
    .setMimeType(ContentService.MimeType.JSON);
}


/**
 * Handles POST requests from the Worker App or Monitor App.
 */
function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.waitLock(30000); 

  try {
    var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(VISITS_SHEET_NAME);
    var data = e.parameter;
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var arrivalTime = data["Arrival Time"];
    var workerName = data["Worker Name"];
    
    var batteryLevelColIdx = headers.indexOf("Battery Level") + 1; 
    var phoneHeaders = ["Worker Phone Number", "Emergency Contact Number", "Escalation Contact Number"];

    // Force phone numbers to text by prepending a single quote
    for (var key in data) {
      if (phoneHeaders.indexOf(key) > -1 && data[key]) {
        var phone = String(data[key]);
        if ((phone.charAt(0) === '0' || phone.charAt(0) === '+') && phone.charAt(0) !== "'") {
          data[key] = "'" + phone;
        }
      }
    }

    // Find existing row or create a new one
    var dataRange = sheet.getDataRange().getValues();
    var rowIndex = -1;
    for (var i = 1; i < dataRange.length; i++) {
      var rowArrivalTimeISO = "";
      try {
          if (dataRange[i][headers.indexOf("Arrival Time")] instanceof Date) {
               rowArrivalTimeISO = dataRange[i][headers.indexOf("Arrival Time")].toISOString();
          } else if (dataRange[i][headers.indexOf("Arrival Time")]) {
               rowArrivalTimeISO = new Date(dataRange[i][headers.indexOf("Arrival Time")]).toISOString();
          }
      } catch (dateErr) {
           Logger.log("Error parsing date in row " + (i+1) + ": " + dataRange[i][headers.indexOf("Arrival Time")]);
      }

      if (dataRange[i][headers.indexOf("Worker Name")] === workerName && rowArrivalTimeISO === arrivalTime) {
        rowIndex = i + 1;
        break;
      }
    }

    if (rowIndex !== -1) {
      // Update existing row
      headers.forEach(function(header) {
        if (data[header] !== undefined) {
          var colIndex = headers.indexOf(header) + 1;
          if (colIndex > 0) {
            sheet.getRange(rowIndex, colIndex).setValue(data[header]);

             // Parse and save numeric battery level
             if (header === "Notes" && data[header] && batteryLevelColIdx > 0) {
                var batteryMatch = data[header].match(/Battery: (\d+)%/);
                if (batteryMatch && batteryMatch[1]) {
                     var level = parseInt(batteryMatch[1], 10);
                     if (!isNaN(level)) {
                          sheet.getRange(rowIndex, batteryLevelColIdx).setValue(level);
                     }
                }
             }
          }
        }
      });
    } else {
      // Append new row
      var newRow = headers.map(function(header) {
        return data[header] || "";
      });
      // Parse and set initial battery level for new row
      if (data["Notes"] && batteryLevelColIdx > 0) {
           var batteryMatch = data["Notes"].match(/Battery: (\d+)%/);
           if (batteryMatch && batteryMatch[1]) {
                var level = parseInt(batteryMatch[1], 10);
                if (!isNaN(level)) {
                     newRow[batteryLevelColIdx - 1] = level; 
                }
           }
      }
      sheet.appendRow(newRow);
      rowIndex = sheet.getLastRow(); // Get the new row index
    }

    // --- MODIFIED: Write alert timestamp ---
    // Immediate alert triggers
    if (['EMERGENCY - PANIC BUTTON', 'DURESS_CODE_ACTIVATED', 'MISSED_CHECKIN'].indexOf(data['Alarm Status']) > -1) {
      // --- NEW: Write the alert timestamp ---
      data["GPS Timestamp"] = new Date().toISOString();
      sheet.getRange(rowIndex, headers.indexOf("GPS Timestamp") + 1).setValue(data["GPS Timestamp"]);
      // --- END NEW ---

      var workerDataForEmail = {};
       if (rowIndex !== -1) {
           var updatedRowValues = sheet.getRange(rowIndex, 1, 1, headers.length).getValues()[0];
            headers.forEach(function(header, j) { 
                 if (phoneHeaders.indexOf(header) > -1 && typeof updatedRowValues[j] === 'string' && updatedRowValues[j].charAt(0) === "'") {
                     workerDataForEmail[header] = updatedRowValues[j].substring(1);
                 } else {
                     workerDataForEmail[header] = updatedRowValues[j];
                 }
            });
       } else {
           workerDataForEmail = { ...data }; // Clone data
            phoneHeaders.forEach(function(header) {
                 if (workerDataForEmail[header] && typeof workerDataForEmail[header] === 'string' && workerDataForEmail[header].charAt(0) === "'") {
                      workerDataForEmail[header] = workerDataForEmail[header].substring(1);
                 }
            });
       }
      sendAlertEmail(workerDataForEmail, data['Alarm Status'], false); // false = isNotEscalation
    }

  } catch (err) {
    Logger.log('Error in doPost: ' + err.toString() + ' | Data: ' + JSON.stringify(e.parameter));
  } finally {
    lock.releaseLock();
  }

  return ContentService.createTextOutput("Success");
}

// --- AUTOMATED TRIGGER FUNCTION ---
// --- UPDATED: This function now handles ALL escalations ---
function checkOverdueWorkers() {
  var lock = LockService.getScriptLock();
  lock.waitLock(30000);

  try {
    var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(VISITS_SHEET_NAME);
    var dataRange = sheet.getDataRange();
    var data = dataRange.getValues();
    var headers = data[0];
    var now = new Date();
    var phoneHeaders = ["Worker Phone Number", "Emergency Contact Number", "Escalation Contact Number"]; 

    var resolvedStatuses = ['DEPARTED', 'SAFE - MANUALLY CLEARED', 'MONITOR_CLEARED_ALERT'];
    var primaryAlertStatuses = ['EMERGENCY - PANIC BUTTON', 'DURESS_CODE_ACTIVATED', 'MISSED_CHECKIN', 'EMAIL_1_SENT', 'EMAIL_2_SENT', 'EMAIL_3_SENT', 'ALERT SENT'];

    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var worker = {};
      headers.forEach(function(header, j) {
        if (phoneHeaders.indexOf(header) > -1 && typeof row[j] === 'string' && row[j].charAt(0) === "'") {
            worker[header] = row[j].substring(1);
        } else {
            worker[header] = row[j];
        }
      });

      var status = worker['Alarm Status'];
      
      // 1. Skip resolved workers
      if (resolvedStatuses.indexOf(status) !== -1 || !worker['Anticipated Departure Time']) continue; 

      var anticipatedDeparture = null;
      try {
            anticipatedDeparture = new Date(worker['Anticipated Departure Time']);
            if (isNaN(anticipatedDeparture.getTime())) {
                 Logger.log("Skipping row " + (i+1) + ": Invalid Anticipated Departure Time format - " + worker['Anticipated Departure Time']);
                 continue; 
            }
      } catch (dateErr) {
            Logger.log("Skipping row " + (i+1) + ": Error parsing Anticipated Departure Time - " + worker['Anticipated Departure Time']);
            continue; 
      }

      var alertToSend = null;
      var overdueMinutes = (now.getTime() - anticipatedDeparture.getTime()) / 60000;
      var escalationTime = parseInt(ESCALATION_MINUTES) || 5; // Use config, default to 5

      // 2. Check for NEW Overdue alerts
      if (status === 'ON SITE' && overdueMinutes > (parseInt(FIRST_ALERT_MINUTES) || 15)) {
          alertToSend = 'EMAIL_1_SENT';
          // --- NEW: Set the alert timestamp for escalation ---
          sheet.getRange(i + 1, headers.indexOf('GPS Timestamp') + 1).setValue(new Date().toISOString());
      
      // 3. Check for Escalation (for ALL alert types)
      } else if (primaryAlertStatuses.includes(status)) {
          var alertTimestampStr = worker['GPS Timestamp']; // This is now the "Alert Time"
          if (!alertTimestampStr) continue; // Should not happen, but safety check

          var alertAgeMinutes = (now.getTime() - new Date(alertTimestampStr).getTime()) / 60000;

          // Handle Panic/Duress/Check-in Escalation
          if (['EMERGENCY - PANIC BUTTON', 'DURESS_CODE_ACTIVATED', 'MISSED_CHECKIN'].includes(status) && alertAgeMinutes > escalationTime) {
              alertToSend = 'ESCALATION_SENT';
          
          // Handle Overdue Escalation
          } else if (status === 'EMAIL_1_SENT' && alertAgeMinutes > escalationTime) {
              alertToSend = 'EMAIL_2_SENT';
          } else if (status === 'EMAIL_2_SENT' && alertAgeMinutes > (escalationTime * 2)) {
              alertToSend = 'EMAIL_3_SENT';
          } else if (status === 'EMAIL_3_SENT' && alertAgeMinutes > (escalationTime * 3)) {
              alertToSend = 'ESCALATION_SENT';
          }
      }

      // 4. Send the new alert if one was triggered
      if (alertToSend) {
        sheet.getRange(i + 1, headers.indexOf('Alarm Status') + 1).setValue(alertToSend);
        worker['Alarm Status'] = alertToSend; 
        
        // If we are escalating, send to the secondary contact
        var isEscalation = (alertToSend === 'ESCALATION_SENT' || alertToSend === 'EMAIL_2_SENT' || alertToSend === 'EMAIL_3_SENT');
        sendAlertEmail(worker, alertToSend, isEscalation);
      }
    }
  } catch (err) {
    Logger.log('Error in checkOverdueWorkers: ' + err.toString());
  } finally {
    lock.releaseLock();
  }
}

// --- NEW: FREE SMS FUNCTION (via TextBelt) ---
/**
 * Sends an SMS using the TextBelt free tier.
 * 1 free SMS per phone number per day.
 * @param {string} phoneNumber - The full international phone number (e.g., +6421123456).
 * @param {string} message - The text message (max 160 chars).
 */
function sendSmsViaGateway(phoneNumber, message) {
  if (!phoneNumber) {
    Logger.log("SMS failed: No phone number provided.");
    return;
  }
  
  const cleanPhone = phoneNumber.replace(/[^\d+]/g, '');
  
  const payload = {
    phone: cleanPhone,
    message: message.substr(0, 160), // Enforce SMS max length
    key: "textbelt" // Use the public free tier key
  };

  try {
    const response = UrlFetchApp.fetch("https://textbelt.com/text", {
      method: "post",
      contentType: "application/json",
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });
    
    const result = JSON.parse(response.getContentText());
    if (result.success) {
      Logger.log("Successfully sent free SMS to: " + cleanPhone);
    } else {
      // --- NEW: Fallback Email to Admin ---
      var adminEmail = Session.getEffectiveUser().getEmail();
      var subject = "OTG AppSuite SMS Failure Notification";
      var body = "An SMS alert to " + cleanPhone + " failed to send.\n\nError: " + result.error + "\n\nThis usually means the 1-per-day free limit for this phone number was exceeded during testing. The primary email alert was still sent.";
      MailApp.sendEmail(adminEmail, subject, body);
      // --- END NEW ---
      Logger.log("Free SMS failed (quota likely used, or invalid number): " + result.error);
    }
  } catch (e) {
    Logger.log("SMS Error: " + e.toString());
  }
}


// --- EMAIL HELPER FUNCTION (Now with SMS) ---
// --- UPDATED: Now accepts an `isEscalation` boolean ---
function sendAlertEmail(workerData, alertType, isEscalation) {
  var recipient = isEscalation ? workerData['Escalation Contact Email'] : workerData['Emergency Contact Email'];
  var phoneRecipient = isEscalation ? workerData['Escalation Contact Number'] : workerData['Emergency Contact Number'];
  var subject = '';
  var body = '';
  var smsMessage = '';

  var locationName = workerData['Location Name'] || 'Not specified';
  var locationAddress = workerData['Location Address'] || 'Not specified';
  var workerName = workerData['Worker Name'] || 'Unknown Worker';
  var workerPhone = workerData['Worker Phone Number'] || 'Not specified';
  var anticipatedDepartureStr = 'Not specified';
   try {
       if (workerData['Anticipated Departure Time']) {
           anticipatedDepartureStr = new Date(workerData['Anticipated Departure Time']).toLocaleString();
       }
   } catch(e){ Logger.log("Could not format Anticipated Departure Time for email: " + workerData['Anticipated Departure Time']); }

  var locationLink = 'http://maps.google.com/?q=' + encodeURIComponent(locationAddress);
  if (workerData['Last Known GPS']) {
    locationLink = 'http://maps.google.com/?q=' + workerData['Last Known GPS'];
  }

  switch(alertType) {
    case 'EMERGENCY - PANIC BUTTON':
      subject = 'URGENT PANIC ALERT for ' + workerName;
      body = '<p><strong>A PANIC ALERT has been triggered by ' + workerName + '.</strong></p> <p>This is a high-priority alert indicating an emergency situation.</p>';
      smsMessage = `PANIC ALERT: ${workerName} at ${locationName}. Location: ${locationLink}`;
      break;
    case 'DURESS_CODE_ACTIVATED':
      subject = 'URGENT DURESS ALERT for ' + workerName;
      body = '<p><strong>A SILENT DURESS ALARM has been triggered by ' + workerName + '.</strong></p> <p>The worker has entered their Duress PIN, suggesting they may be under threat and unable to call for help directly.</p>';
      smsMessage = `DURESS ALERT: ${workerName} at ${locationName}. Location: ${locationLink}`;
      break;
    case 'MISSED_CHECKIN':
      subject = 'MISSED CHECK-IN ALERT for ' + workerName;
      body = '<p><strong>' + workerName + ' has missed a scheduled "Are you OK?" check-in.</strong></p>';
      smsMessage = `MISSED CHECK-IN: ${workerName} at ${locationName}. Location: ${locationLink}`;
      break;
    case 'ESCALATION_SENT':
      subject = 'ESCALATION ALERT: ' + workerName + ' is Overdue/Unresponsive';
      body = '<p>This is an escalation alert. ' + workerName + ' is either 60+ minutes overdue or has not responded to a PANIC/DURESS/MISSED_CHECKIN alert for ' + ESCALATION_MINUTES + ' minutes.</p>';
      smsMessage = `ESCALATION: ${workerName} at ${locationName} is unresponsive. Location: ${locationLink}`;
      break;
    case 'EMAIL_1_SENT':
    case 'EMAIL_2_SENT':
    case 'EMAIL_3_SENT':
      var minutesOverdue = parseInt(FIRST_ALERT_MINUTES) || 15;
      if (alertType === 'EMAIL_2_SENT') minutesOverdue = (parseInt(ESCALATION_MINUTES) || 5) * 1;
      if (alertType === 'EMAIL_3_SENT') minutesOverdue = (parseInt(ESCALATION_MINUTES) || 5) * 2;
      subject = 'Overdue Alert: ' + workerName + ' is ' + minutesOverdue + '+ mins Overdue';
      body = '<p>' + workerName + ' is now more than ' + minutesOverdue + ' minutes overdue.</p>';
      smsMessage = `OVERDUE: ${workerName} is ${minutesOverdue}+ mins overdue at ${locationName}. Location: ${locationLink}`;
      break;
    case 'ALERT SENT': 
         subject = 'Overdue Alert: ' + workerName + ' is overdue';
         body = '<p>' + workerName + ' became overdue and triggered an initial alert state.</p>';
         smsMessage = `OVERDUE: ${workerName} is overdue at ${locationName}. Location: ${locationLink}`;
         break;
    default: 
      subject = 'OTG AppSuite Alert (' + alertType + ') for ' + workerName;
      body = '<p>An automated alert (' + alertType.replace(/_/g,' ') + ') has been triggered for ' + workerName + '.</p>';
      // No SMS for non-critical alerts
      break;
  }

  var fullBody = '<html><body style="font-family: sans-serif; line-height: 1.6;">' + body + 
                   '<hr style="margin: 20px 0;"><h3>Visit Details:</h3><ul>' + 
                   '<li><strong>Worker:</strong> ' + workerName + '</li>' + 
                   '<li><strong>Phone:</strong> ' + workerPhone + '</li>' +
                   '<li><strong>Location:</strong> ' + locationName + '</li>' +
                   '<li><strong>Address:</strong> ' + locationAddress + '</li>' +
                   '<li><strong>Anticipated Departure:</strong> ' + anticipatedDepartureStr + '</li>' +
                   '</ul><p style="font-size: 1.2em; font-weight: bold;"><a href="' + locationLink + '">View Location on Map</a></p>' +
                   '<p style="font-size: 0.8em; color: #888;">This is an automated message from the %%ORGANISATION_NAME%% AppSuite System.</p></body></html>';

  if (recipient) {
    try {
      MailApp.sendEmail({
        to: recipient,
        subject: subject,
        htmlBody: fullBody,
        name: "%%ORGANISATION_NAME%% Alert"
      });
      Logger.log('Email sent to ' + recipient + ' for alert type ' + alertType + ' for worker ' + workerName);
    } catch (e) {
      Logger.log('Failed to send email to ' + recipient + ' for worker ' + workerName + ': ' + e.toString());
    }
  } else {
    Logger.log('Cannot send email: No recipient found for alert type ' + alertType + ' for worker ' + workerName);
  }
  
  // --- NEW: Send SMS in parallel ---
  if (smsMessage && phoneRecipient) {
    sendSmsViaGateway(phoneRecipient, smsMessage);
  }
}
